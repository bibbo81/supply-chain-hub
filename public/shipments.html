<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Spedizioni</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Solarium Design System -->
    <link rel="stylesheet" href="/solarium.css">
    
    <!-- Auth System -->
    <script src="/auth.js"></script>
    
    <!-- Page Protection -->
    <script>
    (function() {
        console.log('[Shipments] Checking authentication...');
                
        function checkAuth() {
            if (!window.auth) {
                setTimeout(checkAuth, 100);
                return;
            }
                        
            if (!window.auth.isAuthenticated()) {
                console.log('[Shipments] Not authenticated, redirecting...');
                window.location.replace('/login.html');
                return;
            }
                        
            console.log('[Shipments] User authenticated');
                        
            const user = window.auth.getCurrentUser();
            if (user) {
                let displayName = 'Utente';
                let initial = 'U';
                
                if (user.user_metadata && user.user_metadata.display_name) {
                    displayName = user.user_metadata.display_name;
                } else if (user.user_metadata && user.user_metadata.full_name) {
                    displayName = user.user_metadata.full_name;
                } else if (user.user_metadata && user.user_metadata.name) {
                    displayName = user.user_metadata.name;
                } else if (user.email) {
                    const emailName = user.email.split('@')[0];
                    displayName = emailName
                        .replace(/[._-]/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                }
                
                if (displayName && displayName.includes('.')) {
                    displayName = displayName
                        .replace(/[._-]/g, ' ')
                        .split(' ')
                        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                        .join(' ');
                }
                                
                const words = displayName.split(' ').filter(w => w.length > 0);
                if (words.length >= 2) {
                    initial = words[0][0].toUpperCase() + words[1][0].toUpperCase();
                } else if (words.length === 1) {
                    initial = words[0][0].toUpperCase();
                }
                                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', function() {
                        updateUserUI(displayName, initial, user.email);
                    });
                } else {
                    updateUserUI(displayName, initial, user.email);
                }
            }
        }
                
        function updateUserUI(displayName, initial, email) {
            const userNameEl = document.getElementById('userName');
            const userInitialEl = document.getElementById('userInitial');
            const userFullNameEl = document.getElementById('userFullName');
            const userEmailEl = document.getElementById('userEmail');
                        
            if (userNameEl) userNameEl.textContent = displayName;
            if (userInitialEl) userInitialEl.textContent = initial;
            if (userFullNameEl) userFullNameEl.textContent = displayName;
            if (userEmailEl) userEmailEl.textContent = email || '';
        }
                
        checkAuth();
    })();
    </script>
    
    <style>
        /* Page Specific Styles */
        .sol-main-content { 
            margin-top: 80px; 
            padding: var(--sol-space-xl); 
            max-width: 1600px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        
        .filter-bar { 
            background: var(--sol-glass-light); 
            backdrop-filter: var(--sol-blur-lg); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: var(--sol-radius-xl); 
            padding: var(--sol-space-lg); 
            margin-bottom: var(--sol-space-2xl); 
            display: flex; 
            gap: var(--sol-space-md); 
            flex-wrap: wrap; 
            align-items: center; 
        }
        
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: var(--sol-space-xs); 
            flex: 1; 
            min-width: 200px; 
        }
        
        .filter-label { 
            font-size: 0.75rem; 
            color: var(--sol-text-tertiary); 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
        }
        
        .table-section { 
            background: var(--sol-glass-light); 
            backdrop-filter: var(--sol-blur-lg); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: var(--sol-radius-xl); 
            overflow: hidden; 
        }
        
        .table-header { 
            padding: var(--sol-space-lg) var(--sol-space-xl); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        .data-table th { 
            background: var(--sol-glass-light); 
            backdrop-filter: var(--sol-blur-lg); 
            padding: var(--sol-space-md); 
            text-align: left; 
            font-weight: 600; 
            font-size: 0.875rem; 
            color: var(--sol-text-secondary); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .data-table td { 
            padding: var(--sol-space-md); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); 
            color: var(--sol-text-primary); 
        }
        
        .data-table tr:hover td { 
            background: rgba(255, 255, 255, 0.02); 
        }
        
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            display: inline-block; 
        }
        
        .status-badge.delivered { 
            background: rgba(52, 199, 89, 0.15); 
            color: #34C759; 
        }
        
        .status-badge.in_transit { 
            background: rgba(0, 122, 255, 0.15); 
            color: #007AFF; 
        }
        
        .status-badge.pending { 
            background: rgba(255, 149, 0, 0.15); 
            color: #FF9500; 
        }
        
        .status-badge.cancelled { 
            background: rgba(255, 59, 48, 0.15); 
            color: #FF3B30; 
        }
        
        .sol-backdrop { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(0, 0, 0, 0.4); 
            backdrop-filter: var(--sol-blur-sm); 
            z-index: 998; 
            opacity: 0; 
            visibility: hidden; 
            transition: var(--sol-transition-base); 
        }
        
        .sol-backdrop.active { 
            opacity: 1; 
            visibility: visible; 
        }

        .sol-dropdown { 
            position: absolute; 
            top: 70px; 
            right: var(--sol-space-xl); 
            background: rgba(20, 20, 30, 0.95) !important; 
            backdrop-filter: var(--sol-blur-xl); 
            -webkit-backdrop-filter: var(--sol-blur-xl); 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            border-radius: var(--sol-radius-lg); 
            padding: var(--sol-space-sm); 
            min-width: 200px; 
            display: none; 
            z-index: 1000; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); 
        }
        
        .sol-dropdown-item { 
            display: block; 
            width: 100%; 
            padding: var(--sol-space-sm) var(--sol-space-md); 
            color: var(--sol-text-primary); 
            text-decoration: none; 
            border-radius: var(--sol-radius-sm); 
            transition: var(--sol-transition-base); 
            background: none; 
            border: none; 
            text-align: left; 
            cursor: pointer; 
        }
        
        .sol-dropdown-item:hover { 
            background: rgba(255, 255, 255, 0.05); 
        }
        
        .sidebar-section-title { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.1em; 
            color: var(--sol-text-tertiary); 
            margin-bottom: var(--sol-space-sm); 
            padding: 0 var(--sol-space-lg); 
        }
        
        .sol-select {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: var(--sol-blur-lg);
            -webkit-backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: var(--sol-radius-md);
            padding: var(--sol-space-sm) var(--sol-space-lg);
            padding-right: var(--sol-space-2xl);
            color: var(--sol-text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--sol-transition-base);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='rgba(255,255,255,0.5)' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--sol-space-md) center;
            width: 100%;
            min-height: 40px;
        }

        .sol-select:hover {
            background-color: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .sol-select:focus {
            outline: none;
            border-color: rgba(0, 122, 255, 0.5);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.06);
        }
        
        @media (max-width: 768px) {
            .filter-bar { 
                flex-direction: column; 
                align-items: stretch; 
            }
            .filter-group { 
                min-width: 100%; 
            }
            .table-wrapper { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch; 
            }
            .data-table { 
                min-width: 800px; 
            }
            .sol-header-center { 
                display: none; 
            }
            .sol-logo-text { 
                display: none; 
            }
            #userName { 
                display: none; 
            }
            #userMenuBtn .fa-chevron-down { 
                display: none; 
            }
        }
        
        .loading-skeleton { 
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%); 
            background-size: 200% 100%; 
            animation: loading 1.5s infinite; 
            border-radius: var(--sol-radius-md); 
        }
        
        @keyframes loading { 
            0% { background-position: 200% 0; } 
            100% { background-position: -200% 0; } 
        }
    </style>
</head>
<body>
    <header class="sol-header" style="overflow: visible;">
        <div class="sol-header-content">
            <div class="sol-header-left" style="display: flex; align-items: center; gap: var(--sol-space-lg);">
                <button class="sol-btn sol-btn-glass" id="menuToggle" style="padding: var(--sol-space-sm);">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/dashboard.html" class="sol-logo">
                    <div class="sol-logo-icon">SCH</div>
                    <span class="sol-logo-text">Supply Chain Hub</span>
                </a>
            </div>
            <div class="sol-header-center" style="flex: 1; max-width: 500px; margin: 0 var(--sol-space-xl);">
                <div style="position: relative;">
                    <input type="search" class="sol-search" placeholder="Cerca spedizioni..." style="padding-left: 2.5rem;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--sol-text-tertiary);"></i>
                </div>
            </div>
            <div class="sol-header-right" style="display: flex; align-items: center; gap: var(--sol-space-md);">
                <button class="sol-btn sol-btn-glass" id="notificationBtn" style="position: relative; padding: var(--sol-space-sm); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bell" style="font-size: 1.25rem;"></i>
                    <span style="position: absolute; top: 9px; right: 6px; background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%); width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: white; box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);">3</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="userMenuBtn" style="display: flex; align-items: center; gap: var(--sol-space-sm);">
                    <div style="width: 32px; height: 32px; background: var(--sol-gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        <span id="userInitial">U</span>
                    </div>
                    <span id="userName">Utente</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="sol-dropdown" id="userDropdown">
                    <div style="padding: var(--sol-space-md); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <p style="font-weight: 600; color: var(--sol-text-primary); margin: 0;" id="userFullName">Nome Utente</p>
                        <p style="font-size: 0.75rem; color: var(--sol-text-secondary); margin: 0; margin-top: 2px;" id="userEmail">email@example.com</p>
                    </div>
                    <a href="/profile.html" class="sol-dropdown-item"><i class="fas fa-user"></i> Profilo</a>
                    <a href="/settings.html" class="sol-dropdown-item"><i class="fas fa-cog"></i> Impostazioni</a>
                    <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: var(--sol-space-sm) 0;"></div>
                    <button class="sol-dropdown-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Esci</button>
                </div>
            </div>
        </div>
    </header>

    <aside class="sol-sidebar" id="sidebar">
        <nav style="padding: var(--sol-space-lg) 0;">
            <div style="margin-bottom: var(--sol-space-xl);">
                <div class="sidebar-section-title">PRINCIPALE</div>
                <a href="/dashboard.html" class="sol-nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
                <a href="/shipments.html" class="sol-nav-item active"><i class="fas fa-box"></i><span>Spedizioni</span></a>
                <a href="/carriers.html" class="sol-nav-item"><i class="fas fa-truck"></i><span>Corrieri</span></a>
                <a href="/tracking.html" class="sol-nav-item"><i class="fas fa-map-marker-alt"></i><span>Tracking</span></a>
            </div>
            <div style="margin-bottom: var(--sol-space-xl);">
                <div class="sidebar-section-title">STRUMENTI</div>
                <a href="/import.html" class="sol-nav-item"><i class="fas fa-upload"></i><span>Importa Dati</span></a>
                <a href="/reports.html" class="sol-nav-item"><i class="fas fa-file-alt"></i><span>Report</span></a>
                <a href="/costs.html" class="sol-nav-item"><i class="fas fa-coins"></i><span>Analisi Costi</span></a>
            </div>
            <div>
                <div class="sidebar-section-title">CONFIGURAZIONE</div>
                <a href="/team.html" class="sol-nav-item"><i class="fas fa-users"></i><span>Team</span></a>
                <a href="/settings.html" class="sol-nav-item"><i class="fas fa-cog"></i><span>Impostazioni</span></a>
                <a href="/billing.html" class="sol-nav-item"><i class="fas fa-credit-card"></i><span>Fatturazione</span></a>
            </div>
        </nav>
    </aside>

    <main class="sol-main-content">
        <div style="margin-bottom: var(--sol-space-2xl);">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: var(--sol-space-sm);">Spedizioni</h1>
            <p style="color: var(--sol-text-secondary);">Gestisci e monitora tutte le tue spedizioni</p>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label class="filter-label">Stato</label>
                <select class="sol-select" id="statusFilter">
                    <option value="">Tutti gli stati</option>
                    <option value="pending">In attesa</option>
                    <option value="in_transit">In transito</option>
                    <option value="delivered">Consegnato</option>
                    <option value="cancelled">Annullato</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Corriere</label>
                <select class="sol-select" id="carrierFilter">
                    <option value="">Tutti i corrieri</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Fornitore</label>
                <select class="sol-select" id="supplierFilter">
                    <option value="">Tutti i fornitori</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Ricerca</label>
                <input type="search" class="sol-input" placeholder="Cerca per riferimento..." id="searchInput" style="width: 100%; padding: var(--sol-space-sm) var(--sol-space-md); background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: var(--sol-radius-md); color: var(--sol-text-primary);">
            </div>
            <div class="filter-group" style="flex: 0; align-self: flex-end;">
                <button class="sol-btn sol-btn-primary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i> Applica Filtri
                </button>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h3 style="font-size: 1.25rem; font-weight: 600;">Lista Spedizioni</h3>
                <div style="display: flex; gap: var(--sol-space-md);">
                    <button class="sol-btn sol-btn-glass" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i> Aggiorna
                    </button>
                    <button class="sol-btn sol-btn-primary" onclick="showAddShipmentModal()">
                        <i class="fas fa-plus"></i> Nuova Spedizione
                    </button>
                </div>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="shipmentsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('rif_spedizione')" style="cursor: pointer;">
                                Rif. Spedizione <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('fornitore')" style="cursor: pointer;">
                                Fornitore <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('spedizioniere')" style="cursor: pointer;">
                                Corriere <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('tipo_spedizione')" style="cursor: pointer;">
                                Tipo <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('data_partenza')" style="cursor: pointer;">
                                Data Partenza <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('status')" style="cursor: pointer;">
                                Stato <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('costo_trasporto')" style="cursor: pointer;">
                                Costo <i class="fas fa-sort"></i>
                            </th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div style="padding: var(--sol-space-lg); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--sol-text-secondary); font-size: 0.875rem;">
                    Mostrando <span id="showingFrom">0</span>-<span id="showingTo">0</span> di <span id="totalRecords">0</span> righe
                </div>
                <div style="display: flex; gap: var(--sol-space-sm);">
                    <button class="sol-btn sol-btn-glass" onclick="previousPage()" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span style="padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary);">
                        Pagina <span id="currentPage">1</span> di <span id="totalPages">1</span>
                    </span>
                    <button class="sol-btn sol-btn-glass" onclick="nextPage()" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div class="sol-backdrop" id="backdrop"></div>

    <script>
        let shipmentsData = [];
        let filteredData = [];
        let currentPage = 1;
        const recordsPerPage = 20;
        let sortColumn = 'data_partenza';
        let sortDirection = 'desc';
        
        document.addEventListener('DOMContentLoaded', function() {
            setupGlobalHeaderListeners();
            setupPageSpecificEventListeners();
            loadShipments();
        });

        function setupGlobalHeaderListeners() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('backdrop');
            if (menuToggle && sidebar && backdrop) {
                menuToggle.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    sidebar.classList.toggle('active'); 
                    backdrop.classList.toggle('active'); 
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : ''; 
                });
                backdrop.addEventListener('click', () => { 
                    sidebar.classList.remove('active'); 
                    backdrop.classList.remove('active'); 
                    document.body.style.overflow = ''; 
                });
            }
            
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none'; 
                });
            }
            
            document.addEventListener('click', (e) => {
                if (userDropdown && userDropdown.style.display !== 'none' && userMenuBtn && !userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
                    userDropdown.style.display = 'none';
                }
            });
            
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) { 
                logoutBtn.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    if (window.auth && window.auth.logout) {
                        window.auth.logout(); 
                    } else { 
                        localStorage.removeItem('sb-access-token'); 
                        localStorage.removeItem('supabase.auth.token'); 
                        localStorage.removeItem('user'); 
                        window.location.replace('/login.html'); 
                    }
                }); 
            }
        }

        function setupPageSpecificEventListeners() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => applyFilters(), 300));
            }
            
            ['statusFilter', 'carrierFilter', 'supplierFilter'].forEach(id => { 
                const el = document.getElementById(id); 
                if (el) el.addEventListener('change', applyFilters); 
            });
        }

        async function loadShipments() {
            showLoadingState(true);
            try {
                const token = localStorage.getItem('sb-access-token') || localStorage.getItem('supabase.auth.token');
                
                // CORREZIONE: Cambiato da get-shipments a shipments
                const response = await fetch('/.netlify/functions/shipments', { 
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) { 
                    console.error('Failed to load shipments, status:', response.status); 
                    showNotification(`Errore caricamento dati (${response.status})`, 'error'); 
                    loadMockData(); 
                    return; 
                }
                
                const result = await response.json();
                shipmentsData = result.data || [];
                applyFiltersAndRender();
                populateFilters();
                
            } catch (error) { 
                console.error('Error loading shipments:', error); 
                showNotification(`Errore: ${error.message}`, 'error'); 
                loadMockData(); 
            } finally { 
                showLoadingState(false); 
            }
        }

        function loadMockData() {
            // Dati di esempio per test
            shipmentsData = [
                {
                    id: '1',
                    rif_spedizione: 'REF-2025-001',
                    fornitore: 'Acme Corp',
                    spedizioniere: 'DHL',
                    tipo_spedizione: 'AEREO',
                    data_partenza: '2025-01-15',
                    status: 'in_transit',
                    costo_trasporto: 3500
                },
                {
                    id: '2',
                    rif_spedizione: 'REF-2025-002',
                    fornitore: 'Global Logistics',
                    spedizioniere: 'FedEx',
                    tipo_spedizione: 'MARE',
                    data_partenza: '2025-01-14',
                    status: 'delivered',
                    costo_trasporto: 1200
                }
            ];
            applyFiltersAndRender();
            populateFilters();
        }

        function applyFiltersAndRender() {
            const status = document.getElementById('statusFilter')?.value;
            const carrier = document.getElementById('carrierFilter')?.value;
            const supplier = document.getElementById('supplierFilter')?.value;
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || "";

            filteredData = shipmentsData.filter(item => 
                (!status || item.status === status) &&
                (!carrier || item.spedizioniere === carrier) &&
                (!supplier || item.fornitore === supplier) &&
                (!searchTerm || Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)))
            );
            
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody'); 
            if (!tbody) return; 
            
            tbody.innerHTML = '';
            
            const sorted = [...filteredData].sort((a, b) => {
                let av = a[sortColumn], bv = b[sortColumn];
                if (sortColumn === 'data_partenza') {
                    av = new Date(av).getTime();
                    bv = new Date(bv).getTime();
                } else if (typeof av === 'string') {
                    av = av.toLowerCase();
                    bv = bv.toLowerCase();
                }
                
                if (av < bv) return sortDirection === 'asc' ? -1 : 1; 
                if (av > bv) return sortDirection === 'asc' ? 1 : -1; 
                return 0;
            });
            
            const total = sorted.length;
            const pages = Math.ceil(total / recordsPerPage); 
            currentPage = Math.min(currentPage, pages) || 1; 
            
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const paginated = sorted.slice(start, end);
            
            if (paginated.length === 0 && total > 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:var(--sol-space-xl)">Nessun dato per questa pagina.</td></tr>`;
            } else if (total === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:var(--sol-space-xl)">Nessuna spedizione trovata.</td></tr>`;
            } else {
                paginated.forEach(item => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = item.rif_spedizione || '-';
                    row.insertCell().textContent = item.fornitore || '-';
                    row.insertCell().textContent = item.spedizioniere || '-';
                    row.insertCell().textContent = item.tipo_spedizione || '-';
                    row.insertCell().textContent = item.data_partenza ? new Date(item.data_partenza).toLocaleDateString('it-IT') : '-';
                    
                    const statusCell = row.insertCell();
                    const statusBadge = document.createElement('span');
                    statusBadge.className = `status-badge ${item.status || 'pending'}`;
                    statusBadge.textContent = getStatusText(item.status || 'pending');
                    statusCell.appendChild(statusBadge);
                    
                    row.insertCell().textContent = formatCurrency(item.costo_trasporto || 0);
                    
                    const actionsCell = row.insertCell();
                    actionsCell.innerHTML = `
                        <button class="sol-btn sol-btn-glass" style="padding: 4px 8px;" onclick="viewShipment('${item.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="sol-btn sol-btn-glass" style="padding: 4px 8px;" onclick="editShipment('${item.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    `;
                });
            }
            
            // Update pagination
            document.getElementById('showingFrom').textContent = total > 0 ? start + 1 : 0; 
            document.getElementById('showingTo').textContent = Math.min(end, total); 
            document.getElementById('totalRecords').textContent = total; 
            document.getElementById('currentPage').textContent = currentPage; 
            document.getElementById('totalPages').textContent = pages > 0 ? pages : 1;
            
            document.getElementById('prevBtn').disabled = currentPage === 1; 
            document.getElementById('nextBtn').disabled = currentPage === pages || pages === 0;
            
            // Update sort icons
            document.querySelectorAll('.data-table th i.fa-sort').forEach(i => i.className = 'fas fa-sort'); 
            const activeSort = document.querySelector(`.data-table th[onclick="sortTable('${sortColumn}')"] i`); 
            if (activeSort) activeSort.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'In attesa',
                'in_transit': 'In transito',
                'delivered': 'Consegnato',
                'cancelled': 'Annullato'
            };
            return statusMap[status] || status;
        }

        function formatCurrency(value) { 
            if (typeof value !== 'number') value = parseFloat(value) || 0; 
            return new Intl.NumberFormat('it-IT', { 
                style: 'currency', 
                currency: 'EUR', 
                minimumFractionDigits: 0, 
                maximumFractionDigits: 0 
            }).format(value); 
        }

        function populateFilters() { 
            const carriers = [...new Set(shipmentsData.map(i => i.spedizioniere).filter(Boolean))].sort();
            const suppliers = [...new Set(shipmentsData.map(i => i.fornitore).filter(Boolean))].sort();
            
            const carrierFilter = document.getElementById('carrierFilter');
            const supplierFilter = document.getElementById('supplierFilter'); 
            
            if (!carrierFilter || !supplierFilter) return; 
            
            const selectedCarrier = carrierFilter.value;
            const selectedSupplier = supplierFilter.value; 
            
            carrierFilter.innerHTML = '<option value="">Tutti i corrieri</option>';
            carriers.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                carrierFilter.appendChild(option);
            }); 
            
            supplierFilter.innerHTML = '<option value="">Tutti i fornitori</option>';
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                supplierFilter.appendChild(option);
            }); 
            
            if (carriers.includes(selectedCarrier)) carrierFilter.value = selectedCarrier; 
            if (suppliers.includes(selectedSupplier)) supplierFilter.value = selectedSupplier; 
        }

        function applyFilters() { 
            currentPage = 1; 
            applyFiltersAndRender(); 
        }

        function sortTable(col) { 
            if (sortColumn === col) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = col;
                sortDirection = 'asc';
            } 
            currentPage = 1; 
            updateTable(); 
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }

        function refreshTable() { 
            loadShipments(); 
            showNotification('Tabella aggiornata.', 'info'); 
        }

        function showAddShipmentModal() { 
            showNotification('Funzione aggiungi spedizione non ancora implementata.', 'info'); 
        }

        function viewShipment(id) { 
            showNotification(`Visualizza spedizione ${id}`, 'info'); 
        }

        function editShipment(id) { 
            showNotification(`Modifica spedizione ${id}`, 'info'); 
        }

        function debounce(fn, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        function showLoadingState(isLoading) {
            const tbody = document.getElementById('tableBody'); 
            if (tbody && isLoading) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;"><div class="loading-skeleton" style="width:80%; height:150px; margin:auto;"></div></td></tr>`;
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `sol-notification sol-notification-${type} sol-animate-in`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                background: var(--sol-glass-heavy);
                color: var(--sol-text-primary);
                border-radius: 8px;
                z-index: 1001;
                border: 1px solid var(--sol-border);
                backdrop-filter: blur(10px);
                box-shadow: var(--sol-shadow-md);
            `;
            
            if (type === 'error') notification.style.borderColor = 'rgba(255, 59, 48, 0.5)';
            if (type === 'success') notification.style.borderColor = 'rgba(52, 199, 89, 0.5)';
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>
</html>