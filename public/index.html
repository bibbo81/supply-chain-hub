<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Advanced Analytics</title>
    <link rel="icon" type="image/x-icon" href="https://cdn.jsdelivr.net/gh/lucide-icons/lucide@latest/icons/truck.svg">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b8bcc8;
            --text-muted: #8b92a5;
            --accent-blue: #00d4ff;
            --accent-purple: #8b5cf6;
            --accent-green: #00ff88;
            --accent-orange: #ff6b35;
            --accent-red: #ff4757;
            --accent-yellow: #ffd93d;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 35px 70px -15px rgba(0, 0, 0, 0.3);
            --border-radius: 16px;
            --border-radius-lg: 24px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 50%, var(--bg-tertiary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 20%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 60%, rgba(0, 255, 136, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundPulse 10s ease-in-out infinite alternate;
        }

        @keyframes backgroundPulse {
            0% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Glass Container */
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .glass-container:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: var(--shadow-xl);
            transform: translateY(-2px);
        }

        /* Header */
        .header {
            padding: 2rem;
            border-bottom: 1px solid var(--glass-border);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .control-button {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        .control-button.refresh-btn {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-blue) 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        }

        .control-button.refresh-btn:hover {
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.4);
            transform: translateY(-2px);
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Status Banner */
        .status-banner {
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius-lg);
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%);
            border: 1px solid rgba(0, 255, 136, 0.2);
            animation: slideInDown 0.8s ease-out;
        }

        .status-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .status-info h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }

        .status-meta {
            display: flex;
            align-items: center;
            gap: 2rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* KPI Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            padding: 2rem;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.8s ease-out;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
            transition: all 0.3s ease;
        }

        .kpi-card:hover::before {
            height: 6px;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            animation: countUp 1.5s ease-out;
        }

        .kpi-growth {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .growth-positive { color: var(--accent-green); }
        .growth-negative { color: var(--accent-red); }
        .growth-neutral { color: var(--text-muted); }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr; 
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-container.glass-container { 
             padding: 2rem;
             min-height: 400px; 
             position: relative;
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chart-wrapper {
            position: relative;
            height: 350px; 
        }
        
        /* Insights Panel */
        .insights-panel { padding: 2rem; animation: slideInLeft 0.8s ease-out; }
        .insight-item { padding: 1rem; margin-bottom: 1rem; border-radius: 12px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; cursor: pointer; }
        .insight-item:hover { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); transform: translateX(5px); }
        .insight-title { font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .insight-description { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.5; }

        /* Alerts Section */
        .alerts-section { margin-bottom: 2rem; }
        .alert-item { padding: 1.5rem; margin-bottom: 1rem; border-radius: var(--border-radius); border-left: 4px solid; animation: slideInRight 0.8s ease-out; }
        .alert-critical { background: rgba(255,71,87,0.1); border-left-color: var(--accent-red); border: 1px solid rgba(255,71,87,0.2); }
        .alert-warning { background: rgba(255,183,77,0.1); border-left-color: var(--accent-orange); border: 1px solid rgba(255,183,77,0.2); }
        .alert-info { background: rgba(0,212,255,0.1); border-left-color: var(--accent-blue); border: 1px solid rgba(0,212,255,0.2); }
        .alert-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .alert-priority { font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .priority-high { background: rgba(255,71,87,0.2); color: var(--accent-red); }
        .priority-medium { background: rgba(255,183,77,0.2); color: var(--accent-orange); }
        .priority-low { background: rgba(0,212,255,0.2); color: var(--accent-blue); }

        /* Data Tables */
        .data-section { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .data-table.glass-container { padding: 2rem; } 
        .table-title { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--glass-border); }
        table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.02); }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.05); }
        th { background: rgba(255,255,255,0.05); font-weight: 600; color: var(--text-secondary); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        td { color: var(--text-primary); }
        tr:hover { background: rgba(255,255,255,0.03); }

        /* Footer */
        .footer { padding: 2rem; text-align: center; border-top: 1px solid var(--glass-border); background: rgba(0,0,0,0.2); margin-top: 2rem; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; }
        .footer-info { color: var(--text-muted); font-size: 0.9rem; }
        .footer-version { background: var(--glass-bg); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid var(--glass-border); font-size: 0.8rem; color: var(--text-secondary); }

        /* Loading States */
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--glass-border); border-radius: 50%; border-top-color: var(--accent-blue); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 8px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Responsive Design */
        @media (max-width: 1200px) { .charts-section, .data-section { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .main-content { padding: 1rem; } .header-content, .status-content { flex-direction: column; text-align: center; } .header-title h1 { font-size: 2rem; } .kpi-grid { grid-template-columns: 1fr; } }

        /* Animations */
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes countUp { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .hidden { display: none !important; }
        .error-state { text-align: center; padding: 2rem; color: var(--text-muted); }
        .error-state h3 { color: var(--accent-red); margin-bottom: 1rem; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <div class="header-logo">ðŸšš</div>
                <div>
                    <h1>Supply Chain Hub</h1>
                    <p style="color: var(--text-secondary); font-size: 1rem; margin-top: 0.5rem;">Advanced Analytics Dashboard</p>
                </div>
            </div>
            <div class="header-controls">
                <select id="monthSelector" class="control-button"><option value="">Select Month</option></select>
                <select id="yearSelector" class="control-button"><option value="">Select Year</option></select>
                <button id="refreshBtn" class="control-button refresh-btn">
                    <span id="refreshText">ðŸ”„ Refresh Data</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <section id="statusBanner" class="status-banner glass-container">
            <div class="status-content">
                <div class="status-info">
                    <h2 id="statusTitle">Loading Analytics...</h2>
                    <p id="statusDescription">Fetching latest supply chain data</p>
                </div>
                <div class="status-meta">
                    <span id="lastUpdated">Updated: --</span>
                    <span id="dataQuality">Quality: --</span>
                    <span id="systemHealth">System: --</span>
                </div>
            </div>
        </section>

        <section class="kpi-grid">
            <div class="kpi-card glass-container"><div class="kpi-header"><span class="kpi-title">Total Shipments</span><div class="kpi-icon" style="background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);">ðŸ“¦</div></div><div class="kpi-value" id="totalShipments">--</div><div class="kpi-growth" id="shipmentsGrowth"><span class="growth-indicator">--</span><span>vs last month</span></div></div>
            <div class="kpi-card glass-container"><div class="kpi-header"><span class="kpi-title">Total Revenue</span><div class="kpi-icon" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-blue) 100%);">ðŸ’°</div></div><div class="kpi-value" id="totalRevenue">--</div><div class="kpi-growth" id="revenueGrowth"><span class="growth-indicator">--</span><span>vs last month</span></div></div>
            <div class="kpi-card glass-container"><div class="kpi-header"><span class="kpi-title">Average Cost</span><div class="kpi-icon" style="background: linear-gradient(135deg, var(--accent-orange) 0%, var(--accent-red) 100%);">ðŸ“Š</div></div><div class="kpi-value" id="avgCost">--</div><div class="kpi-growth" id="costGrowth"><span class="growth-indicator">--</span><span>vs last month</span></div></div>
            <div class="kpi-card glass-container"><div class="kpi-header"><span class="kpi-title">Delivery Rate</span><div class="kpi-icon" style="background: linear-gradient(135deg, var(--accent-green) 0%, var(--accent-yellow) 100%);">ðŸŽ¯</div></div><div class="kpi-value" id="deliveryRate">--</div><div class="kpi-growth" id="deliveryGrowth"><span class="growth-indicator">--</span><span>performance</span></div></div>
        </section>

        <section class="charts-section">
            <div class="chart-container glass-container">
                <h3 class="chart-title">ðŸ“ˆ Shipment Trends</h3>
                <div class="chart-wrapper">
                    <canvas id="shipmentChart"></canvas>
                </div>
            </div>
            <div class="insights-panel glass-container">
                <h3 class="chart-title">ðŸ¤– AI Insights</h3>
                <div id="insightsContainer">
                    <div class="insight-item loading-skeleton" style="height: 80px; border-radius: 12px;"></div>
                    <div class="insight-item loading-skeleton" style="height: 80px; border-radius: 12px; margin-top: 1rem;"></div>
                    <div class="insight-item loading-skeleton" style="height: 80px; border-radius: 12px; margin-top: 1rem;"></div>
                </div>
            </div>
        </section>

        <section id="alertsSection" class="alerts-section"></section>

        <section class="data-section">
            <div class="data-table glass-container">
                <h3 class="table-title">ðŸš› Carrier Performance</h3>
                <div class="table-container">
                    <table><thead><tr><th>Carrier</th><th>Shipments</th><th>Avg Cost</th><th>Delivery Rate</th><th>Market Share</th></tr></thead><tbody id="carrierTableBody"><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr></tbody></table>
                </div>
            </div>
            <div class="data-table glass-container">
                <h3 class="table-title">ðŸ“‹ Recent Shipments</h3>
                <div class="table-container">
                    <table><thead><tr><th>Order #</th><th>Carrier</th><th>Status</th><th>Cost</th><th>Date</th></tr></thead><tbody id="recentTableBody"><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr><tr><td colspan="5" class="loading-skeleton" style="height: 40px;"></td></tr></tbody></table>
                </div>
            </div>
        </section>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-info"><p>&copy; 2025 Supply Chain Hub. Advanced Analytics Platform v2.0</p><p>Powered by Dark Glass Theme & AI-Driven Insights</p></div>
            <div class="footer-version"><span id="apiVersion">API v2.0.0</span> | <span id="lastRefresh">Cache: --</span></div>
        </div>
    </footer>

    <script>
        // ====================================================================
        // SUPPLY CHAIN HUB - FRONTEND JAVASCRIPT
        // Dark Glass Theme with Advanced Analytics
        // ====================================================================

        class SupplyChainDashboard {
            constructor() {
                this.apiEndpoint = '/.netlify/functions/dashboard-stats';
                this.charts = {}; // Store chart instances here
                this.data = null;
                this.currentYear = new Date().getFullYear();
                this.currentMonth = new Date().getMonth() + 1;
                
                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.populateSelectors();
                await this.loadData();
                this.startAutoRefresh();
                
                setTimeout(() => {
                    document.body.classList.add('loaded');
                }, 500);
            }

            setupEventListeners() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.refreshData());
                document.getElementById('yearSelector').addEventListener('change', (e) => this.changeYear(e.target.value));
                document.getElementById('monthSelector').addEventListener('change', (e) => this.changeMonth(e.target.value));
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        this.refreshData();
                    }
                });
            }

            populateSelectors() {
                const yearSelector = document.getElementById('yearSelector');
                const monthSelector = document.getElementById('monthSelector');
                
                for (let year = this.currentYear; year >= this.currentYear - 2; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === this.currentYear) option.selected = true;
                    yearSelector.appendChild(option);
                }
                
                const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((month, index) => {
                    const option = document.createElement('option');
                    option.value = index + 1;
                    option.textContent = month;
                    if (index + 1 === this.currentMonth) option.selected = true;
                    monthSelector.appendChild(option);
                });
            }

            async loadData(refresh = false) {
                try {
                    this.showLoading();
                    
                    const params = new URLSearchParams({
                        year: this.currentYear,
                        month: this.currentMonth
                    });
                    
                    if (refresh) {
                        params.append('refresh', 'true');
                    }
                    
                    const fullApiUrl = `${this.apiEndpoint}?${params}`;
                    // console.log("Attempting to fetch:", fullApiUrl); // Aggiunto per debugging, rimuovere o commentare se non serve

                    const response = await fetch(fullApiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    this.data = await response.json();
                    
                    if (!this.data.success) {
                        throw new Error(this.data.message || 'API returned error');
                    }
                    
                    this.updateDashboard();
                    this.hideLoading();
                    
                    console.log('Dashboard data loaded successfully:', this.data);
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showError(error.message);
                    this.hideLoading();
                }
            }

            async refreshData() {
                const btn = document.getElementById('refreshBtn');
                const text = document.getElementById('refreshText');
                
                btn.disabled = true;
                text.innerHTML = '<span class="loading-spinner"></span> Refreshing...';
                
                try {
                    await this.loadData(true);
                    text.textContent = 'âœ… Refreshed!';
                    setTimeout(() => {
                        text.textContent = 'ðŸ”„ Refresh Data';
                        btn.disabled = false;
                    }, 2000);
                } catch (error) {
                    text.textContent = 'âŒ Failed';
                    setTimeout(() => {
                        text.textContent = 'ðŸ”„ Refresh Data';
                        btn.disabled = false;
                    }, 3000);
                }
            }

            changeYear(year) {
                if (year && year !== this.currentYear.toString()) {
                    this.currentYear = parseInt(year);
                    this.loadData();
                }
            }

            changeMonth(month) {
                if (month && month !== this.currentMonth.toString()) {
                    this.currentMonth = parseInt(month);
                    this.loadData();
                }
            }

            updateDashboard() {
                if (!this.data) return;
                
                this.updateStatusBanner();
                this.updateKPIs();
                this.updateCharts(); 
                this.updateInsights();
                this.updateAlerts();
                this.updateTables();
                this.updateFooter();
            }

            updateStatusBanner() {
                const { period, insights, performance } = this.data;
                document.getElementById('statusTitle').textContent = insights?.summary || 'Analytics Updated';
                document.getElementById('statusDescription').textContent = `${period.monthName} ${period.year} Performance Summary`;
                const lastUpdated = new Date(this.data.timestamp).toLocaleString();
                const dataQuality = performance?.dataQuality?.score || 0;
                const systemHealth = performance?.systemHealth || 'unknown';
                document.getElementById('lastUpdated').textContent = `Updated: ${lastUpdated}`;
                document.getElementById('dataQuality').textContent = `Quality: ${dataQuality.toFixed(0)}%`;
                document.getElementById('systemHealth').textContent = `System: ${systemHealth}`;
            }

            updateKPIs() {
                const { current, growth } = this.data;
                this.animateValue('totalShipments', current.month.shipments);
                this.updateGrowthIndicator('shipmentsGrowth', growth.mom.shipments, growth.mom.trend);
                this.animateValue('totalRevenue', `â‚¬${this.formatNumber(current.month.revenue)}`);
                this.updateGrowthIndicator('revenueGrowth', growth.mom.revenue, growth.mom.trend);
                this.animateValue('avgCost', `â‚¬${current.month.avgCost.toFixed(2)}`);
                this.updateGrowthIndicator('costGrowth', growth.mom.avgCost, growth.mom.trend);
                this.animateValue('deliveryRate', `${current.month.deliveryRate.toFixed(1)}%`);
                this.updateDeliveryPerformance('deliveryGrowth', current.month.deliveryRate);
            }

            updateGrowthIndicator(elementId, growth, trend) {
                const element = document.getElementById(elementId);
                if (!element) return;
                const indicator = element.querySelector('.growth-indicator');
                if (!indicator) return;
                
                let className = 'growth-neutral';
                let symbol = 'â†’';
                if (growth > 0) { className = 'growth-positive'; symbol = 'â†—'; }
                else if (growth < 0) { className = 'growth-negative'; symbol = 'â†˜'; }
                element.className = `kpi-growth ${className}`;
                indicator.textContent = `${symbol} ${Math.abs(growth).toFixed(1)}%`;
            }

            updateDeliveryPerformance(elementId, rate) {
                 const element = document.getElementById(elementId);
                if (!element) return;
                const indicator = element.querySelector('.growth-indicator');
                 if (!indicator) return;

                let className = 'growth-neutral';
                let text = 'Stable';
                if (rate >= 95) { className = 'growth-positive'; text = 'Excellent'; }
                else if (rate >= 85) { className = 'growth-positive'; text = 'Good'; }
                else if (rate >= 75) { className = 'growth-neutral'; text = 'Fair'; }
                else { className = 'growth-negative'; text = 'Poor'; }
                element.className = `kpi-growth ${className}`;
                indicator.textContent = text;
            }

            updateCharts() {
                if (!this.data.charts) {
                    console.warn("Chart data is missing from API response.");
                    return;
                }
                this.createShipmentChart();
                this.createDistributionChart(); 
            }

            createShipmentChart() {
                const ctx = document.getElementById('shipmentChart');
                if (!ctx) return;
                if (this.charts.shipment) this.charts.shipment.destroy();
                
                const { labels, shipments } = this.data.charts;
                if (!labels || !shipments || !shipments.current || !shipments.previous) {
                    console.warn("Shipment chart data is incomplete.");
                    return;
                }

                this.charts.shipment = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: `${this.currentYear}`, data: shipments.current, borderColor: 'rgba(0, 212, 255, 1)', backgroundColor: 'rgba(0, 212, 255, 0.1)', borderWidth: 3, fill: true, tension: 0.4, pointBackgroundColor: 'rgba(0, 212, 255, 1)', pointBorderColor: '#ffffff', pointBorderWidth: 2, pointRadius: 6, pointHoverRadius: 8 },
                            { label: `${this.currentYear - 1}`, data: shipments.previous, borderColor: 'rgba(139, 92, 246, 0.7)', backgroundColor: 'rgba(139, 92, 246, 0.05)', borderWidth: 2, fill: false, tension: 0.4, pointBackgroundColor: 'rgba(139, 92, 246, 0.7)', pointBorderColor: '#ffffff', pointBorderWidth: 1, pointRadius: 4, pointHoverRadius: 6 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { color: '#b8bcc8', font: { size: 12, weight: '600' }, usePointStyle: true, pointStyle: 'circle' } }, tooltip: { backgroundColor: 'rgba(15, 15, 35, 0.95)', titleColor: '#ffffff', bodyColor: '#b8bcc8', borderColor: 'rgba(255, 255, 255, 0.1)', borderWidth: 1, cornerRadius: 8, displayColors: true, callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y} shipments`; } } } }, scales: { x: { grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false }, ticks: { color: '#8b92a5', font: { size: 11 } } }, y: { grid: { color: 'rgba(255, 255, 255, 0.05)', drawBorder: false }, ticks: { color: '#8b92a5', font: { size: 11 }, callback: function(value) { return value.toLocaleString(); } } } }, interaction: { intersect: false, mode: 'index' }, elements: { line: { borderCapStyle: 'round', borderJoinStyle: 'round' } } }
                });
            }

            createDistributionChart() { 
                // NOTA: Nel tuo HTML "Dark Glass Theme" non c'Ã¨ un canvas con id 'distributionChart'.
                // Questa funzione cerca 'distributionChart'. Se vuoi un grafico a ciambella
                // per 'this.data.status.distribution', dovrai aggiungere un <canvas id="distributionChart"></canvas>
                // nell'HTML, probabilmente nella sezione '.insights-panel' o in una nuova '.chart-container'.

                const ctx = document.getElementById('distributionChart'); 
                if (!ctx) {
                    const distributionData = this.data.status?.distribution;
                    if(distributionData && (distributionData.consegnato || distributionData.in_transito || distributionData.arrivato)) {
                        console.log("Data for distribution chart found, but no canvas with id 'distributionChart' in HTML. Skipping chart creation.");
                    } else {
                        console.warn("Distribution chart data is missing or empty, and no canvas found.");
                    }
                    return; 
                }

                if (this.charts.distribution) this.charts.distribution.destroy();

                const distributionData = this.data.status?.distribution;
                if (!distributionData || (!distributionData.consegnato && !distributionData.in_transito && !distributionData.arrivato)) {
                     console.warn("Distribution chart data is missing or effectively empty.");
                     return;
                }

                this.charts.distribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Consegnato', 'In Transito', 'Arrivato'], // Assicurati che questi label corrispondano
                        datasets: [{
                            data: [
                                distributionData.consegnato || 0, 
                                distributionData.in_transito || 0, 
                                distributionData.arrivato || 0
                            ],
                            backgroundColor: ['var(--accent-green)', 'var(--accent-orange)', 'var(--accent-blue)'],
                            borderColor: 'var(--bg-secondary)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: 'var(--text-secondary)'}}
                        }
                    }
                });
            }

            updateInsights() {
                const container = document.getElementById('insightsContainer');
                if (!this.data.insights || !container) return;
                const { insights } = this.data;
                container.innerHTML = '';
                if (insights.summary) this.addInsightItem(container, 'ðŸ“Š Summary', insights.summary, 'summary');
                if (insights.trends) this.addInsightItem(container, 'ðŸ“ˆ Trend Analysis', insights.trends, 'trend');
                if (insights.predictions) this.addInsightItem(container, 'ðŸ”® Forecast', insights.predictions, 'prediction');
                if (insights.marketAnalysis) this.addInsightItem(container, 'ðŸ¢ Market Analysis', insights.marketAnalysis, 'market');
                if (insights.recommendations && insights.recommendations.length > 0) {
                    insights.recommendations.slice(0, 2).forEach((rec, index) => {
                        this.addInsightItem(container, `ðŸ’¡ Recommendation ${index + 1}`, rec, 'recommendation');
                    });
                }
            }

            addInsightItem(container, title, description, type) {
                const item = document.createElement('div'); item.className = 'insight-item';
                const titleEl = document.createElement('div'); titleEl.className = 'insight-title'; titleEl.textContent = title;
                const descEl = document.createElement('div'); descEl.className = 'insight-description'; descEl.textContent = description;
                item.appendChild(titleEl); item.appendChild(descEl); container.appendChild(item);
            }

            updateAlerts() {
                const section = document.getElementById('alertsSection');
                if (!this.data.insights || !this.data.insights.alerts || !section) {
                    if(section) section.innerHTML = ''; return;
                }
                const alerts = this.data.insights.alerts;
                section.innerHTML = '';
                if (alerts.length === 0) return;
                alerts.forEach(alert => {
                    const alertEl = document.createElement('div'); alertEl.className = `alert-item alert-${alert.type}`;
                    alertEl.innerHTML = `<div class="alert-header"><strong>${alert.message}</strong><span class="alert-priority priority-${alert.priority}">${alert.priority}</span></div><div style="margin-top: 0.5rem; color: var(--text-secondary);">${alert.action}</div>${alert.impact ? `<div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-muted);"><strong>Impact:</strong> ${alert.impact}</div>` : ''}`;
                    section.appendChild(alertEl);
                });
            }

            updateTables() {
                this.updateCarrierTable();
                this.updateRecentTable();
            }

            updateCarrierTable() {
                const tbody = document.getElementById('carrierTableBody');
                 if (!tbody) return;
                if (!this.data.carriers || !this.data.carriers.performance) { tbody.innerHTML = '<tr><td colspan="5" class="error-state">No carrier data available</td></tr>'; return; }
                const carriers = this.data.carriers.performance;
                tbody.innerHTML = '';
                carriers.slice(0, 5).forEach(carrier => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td><strong>${carrier.carrier_name}</strong></td><td>${carrier.total_shipments}</td><td>â‚¬${parseFloat(carrier.avg_cost).toFixed(2)}</td><td><span class="${(carrier.delivery_rate * 100) >= 90 ? 'growth-positive' : (carrier.delivery_rate * 100) >= 80 ? 'growth-neutral' : 'growth-negative'}">${(carrier.delivery_rate * 100).toFixed(1)}%</span></td><td>${parseFloat(carrier.market_share).toFixed(1)}%</td>`;
                    tbody.appendChild(row);
                });
                if (carriers.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="error-state">No carrier performance data available</td></tr>'; }
            }

            updateRecentTable() {
                const tbody = document.getElementById('recentTableBody');
                if (!tbody) return;
                if (!this.data.recent) { tbody.innerHTML = '<tr><td colspan="5" class="error-state">No recent shipments data available</td></tr>'; return; }
                const recent = this.data.recent;
                tbody.innerHTML = '';
                recent.slice(0, 5).forEach(shipment => {
                    const row = document.createElement('tr');
                    const statusClass = shipment.status === 'CONSEGNATO' ? 'growth-positive' : shipment.status === 'IN TRANSITO' ? 'growth-neutral' : 'growth-negative';
                    const formattedDate = shipment.shippedDate ? new Date(shipment.shippedDate).toLocaleDateString() : '--';
                    row.innerHTML = `<td><strong>${shipment.orderNumber || shipment.id}</strong></td><td>${shipment.carrier || '--'}</td><td><span class="${statusClass}">${shipment.status || '--'}</span></td><td>â‚¬${(shipment.cost || 0).toFixed(2)}</td><td>${formattedDate}</td>`;
                    tbody.appendChild(row);
                });
                if (recent.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="error-state">No recent shipments available</td></tr>'; }
            }

            updateFooter() {
                const apiVersionEl = document.getElementById('apiVersion');
                const lastRefreshEl = document.getElementById('lastRefresh');
                if (this.data.version && apiVersionEl) apiVersionEl.textContent = `API v${this.data.version}`;
                if (this.data.performance && this.data.performance.cacheStatus && lastRefreshEl) lastRefreshEl.textContent = `Cache: ${this.data.performance.cacheStatus}`;
            }

            animateValue(elementId, targetValue) {
                const element = document.getElementById(elementId);
                if (!element) return;
                element.style.opacity = '0';
                setTimeout(() => { element.textContent = targetValue; element.style.opacity = '1'; }, 150);
            }

            formatNumber(num) {
                if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                else if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
                else return num.toFixed(2);
            }

            showLoading() {
                const elements = document.querySelectorAll('.kpi-value');
                elements.forEach(el => el.classList.add('pulse'));
            }

            hideLoading() {
                const elements = document.querySelectorAll('.kpi-value');
                elements.forEach(el => el.classList.remove('pulse'));
            }

            showError(message) {
                const statusTitle = document.getElementById('statusTitle');
                const statusDescription = document.getElementById('statusDescription');
                if(statusTitle) statusTitle.textContent = 'âŒ Error Loading Data';
                if(statusDescription) statusDescription.textContent = message;
                const banner = document.getElementById('statusBanner');
                if(banner) {
                    banner.style.background = 'linear-gradient(135deg, rgba(255, 71, 87, 0.1) 0%, rgba(255, 183, 77, 0.1) 100%)';
                    banner.style.borderColor = 'rgba(255, 71, 87, 0.2)';
                }
            }

            startAutoRefresh() {
                setInterval(() => { this.loadData(); }, 5 * 60 * 1000);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new SupplyChainDashboard();
        });

        document.addEventListener('DOMContentLoaded', () => {
            const cards = document.querySelectorAll('.glass-container');
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => { card.style.transform = 'translateY(-4px) scale(1.01)'; });
                card.addEventListener('mouseleave', () => { card.style.transform = 'translateY(0) scale(1)'; });
            });
            const buttons = document.querySelectorAll('.control-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    button.style.transform = 'scale(0.95)';
                    setTimeout(() => { button.style.transform = 'scale(1)'; }, 150);
                });
            });
        });
    </script>
</body>
</html>
