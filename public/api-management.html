<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - API Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding-top: 80px; /* Spazio per il menu hamburger */
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .header h1 {
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-tab.active {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .nav-tab:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 20px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .api-provider {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .api-provider:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .api-provider h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #1e7e34;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .tracking-section {
            background: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .tracking-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .tracking-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        
        .tracking-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background: white;
        }
        
        .shipment-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        
        .shipment-card h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .shipment-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .detail-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border-left: 3px solid #3498db;
        }
        
        .detail-label {
            font-size: 12px;
            color: #6c757d;
            font-weight: 600;
        }
        
        .detail-value {
            font-size: 14px;
            color: #2c3e50;
            margin-top: 2px;
        }
        
        .sync-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .sync-option {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .alert {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-cogs"></i>
                Supply Chain Hub - API Management
            </h1>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('config')">
                    <i class="fas fa-settings"></i> Configurazione API
                </button>
                <button class="nav-tab" onclick="showTab('tracking')">
                    <i class="fas fa-search"></i> Tracking Real-time
                </button>
                <button class="nav-tab" onclick="showTab('sync')">
                    <i class="fas fa-sync"></i> Sincronizzazione
                </button>
                <button class="nav-tab" onclick="showTab('stats')">
                    <i class="fas fa-chart-bar"></i> Statistiche
                </button>
            </div>
        </div>

        <!-- TAB CONFIGURAZIONE API -->
        <div id="config" class="tab-content active">
            <h2><i class="fas fa-plug"></i> Configurazione Providers API</h2>
            
            <!-- ShipsGo Container API -->
            <div class="api-provider">
                <h3>
                    <i class="fas fa-ship"></i>
                    ShipsGo Container API
                    <span class="status-badge status-active" id="shipsgo-container-status">ATTIVO</span>
                </h3>
                <div class="form-group">
                    <label>Auth Code:</label>
                    <input type="text" id="shipsgo-container-auth" value="2dc0c6d92ccb59e7d903825c4ebeb521" readonly>
                </div>
                <div class="form-group">
                    <label>Base URL:</label>
                    <input type="text" id="shipsgo-container-url" value="https://shipsgo.com/api/v1.2/ContainerService/" readonly>
                </div>
                <button class="btn btn-primary" onclick="testApiConnection('shipsgo_container')">
                    <i class="fas fa-check"></i> Test Connessione
                </button>
                <button class="btn btn-success" onclick="testWithContainer()">
                    <i class="fas fa-search"></i> Test con Container
                </button>
                <button class="btn btn-warning" onclick="updateApiConfig('shipsgo_container')">
                    <i class="fas fa-save"></i> Aggiorna Config
                </button>
            </div>

            <!-- ShipsGo Air API -->
            <div class="api-provider">
                <h3>
                    <i class="fas fa-plane"></i>
                    ShipsGo Air API
                    <span class="status-badge status-active" id="shipsgo-air-status">ATTIVO</span>
                </h3>
                <div class="form-group">
                    <label>Auth Token:</label>
                    <input type="text" id="shipsgo-air-token" value="505751c2-2745-4d83-b4e7-d35ccddd0628" readonly>
                </div>
                <div class="form-group">
                    <label>Base URL:</label>
                    <input type="text" id="shipsgo-air-url" value="https://api.shipsgo.com/v2/air/" readonly>
                </div>
                <button class="btn btn-primary" onclick="testApiConnection('shipsgo_air')">
                    <i class="fas fa-check"></i> Test Connessione
                </button>
                <button class="btn btn-warning" onclick="updateApiConfig('shipsgo_air')">
                    <i class="fas fa-save"></i> Aggiorna Config
                </button>
            </div>

            <!-- Parcel App API -->
            <div class="api-provider">
                <h3>
                    <i class="fas fa-box"></i>
                    Parcel App API
                    <span class="status-badge status-active" id="parcel-app-status">ATTIVO</span>
                </h3>
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="text" id="parcel-app-key" value="_vnMaCsRMjuWOZwTfwgAW7u0iRk03XfTEuO3QLYNWfdgwhAEbQbXoyTeWAdkzFAcrsDqBsE5Ula" readonly>
                </div>
                <div class="form-group">
                    <label>Base URL:</label>
                    <input type="text" id="parcel-app-url" value="https://api.parcel.app/external/" readonly>
                </div>
                <button class="btn btn-primary" onclick="testApiConnection('parcel_app')">
                    <i class="fas fa-check"></i> Test Connessione
                </button>
                <button class="btn btn-warning" onclick="updateApiConfig('parcel_app')">
                    <i class="fas fa-save"></i> Aggiorna Config
                </button>
            </div>
        </div>

        <!-- TAB TRACKING REAL-TIME -->
        <div id="tracking" class="tab-content">
            <h2><i class="fas fa-search"></i> Tracking Real-time</h2>
            
            <div class="tracking-section">
                <h3>Ricerca Container/Spedizioni</h3>
                <div class="tracking-input">
                    <input type="text" id="tracking-number" placeholder="Inserisci numero container, AWB o tracking number...">
                    <select id="tracking-provider">
                        <option value="auto">Auto-detect</option>
                        <option value="shipsgo_container">ShipsGo Container</option>
                        <option value="shipsgo_air">ShipsGo Air</option>
                        <option value="parcel_app">Parcel App</option>
                    </select>
                    <button class="btn btn-primary" onclick="trackShipment()">
                        <i class="fas fa-search"></i> Traccia
                    </button>
                </div>
                
                <div id="tracking-results" class="tracking-results">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Inserisci un numero di tracking per iniziare la ricerca
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB SINCRONIZZAZIONE -->
        <div id="sync" class="tab-content">
            <h2><i class="fas fa-sync"></i> Sincronizzazione Automatica</h2>
            
            <div class="sync-section">
                <h3>Opzioni di Sincronizzazione</h3>
                <div class="sync-options">
                    <div class="sync-option">
                        <h4><i class="fas fa-download"></i> Import Spedizioni</h4>
                        <p>Importa automaticamente nuove spedizioni dalle API esterne</p>
                        <button class="btn btn-success" onclick="syncShipments('import')">
                            Avvia Import
                        </button>
                    </div>
                    
                    <div class="sync-option">
                        <h4><i class="fas fa-refresh"></i> Aggiorna Status</h4>
                        <p>Aggiorna lo stato delle spedizioni esistenti</p>
                        <button class="btn btn-warning" onclick="syncShipments('update')">
                            Aggiorna Status
                        </button>
                    </div>
                    
                    <div class="sync-option">
                        <h4><i class="fas fa-clock"></i> Sync Programmata</h4>
                        <p>Configura sincronizzazione automatica</p>
                        <button class="btn btn-primary" onclick="configureScheduledSync()">
                            Configura
                        </button>
                    </div>
                    
                    <div class="sync-option">
                        <h4><i class="fas fa-history"></i> Log Sync</h4>
                        <p>Visualizza storico sincronizzazioni</p>
                        <button class="btn btn-primary" onclick="showSyncLogs()">
                            Visualizza Log
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="sync-results" style="margin-top: 20px;"></div>
        </div>

        <!-- TAB STATISTICHE -->
        <div id="stats" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> Statistiche API</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-api-calls">0</div>
                    <div class="stat-label">API Calls Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successful-calls">0</div>
                    <div class="stat-label">Chiamate Riuscite</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failed-calls">0</div>
                    <div class="stat-label">Chiamate Fallite</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="synced-shipments">0</div>
                    <div class="stat-label">Spedizioni Sincronizzate</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <h3>Performance API per Provider</h3>
                <div id="api-performance-chart" style="height: 300px; background: white; border-radius: 10px; padding: 20px; margin-top: 15px;">
                    <div class="loading">
                        <div class="spinner"></div>
                        Caricamento statistiche...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione API
        const API_BASE_URL = '/.netlify/functions';
        let currentProviders = {};

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadApiConfiguration();
            loadStats();
        });

        // Gestione Tab
        function showTab(tabName) {
            // Nascondi tutti i tab
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostra tab selezionato
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Carica dati specifici per tab
            if (tabName === 'stats') {
                loadStats();
            }
        }

        // Carica configurazione API
        async function loadApiConfiguration() {
            try {
                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_config' })
                });
                
                const result = await response.json();
                if (result.success) {
                    currentProviders = result.data;
                    updateProviderStatus();
                }
            } catch (error) {
                console.error('Errore caricamento configurazione:', error);
                showAlert('Errore nel caricamento della configurazione API', 'danger');
            }
        }

        // Aggiorna stato providers
        function updateProviderStatus() {
            for (const [provider, config] of Object.entries(currentProviders)) {
                const statusElement = document.getElementById(`${provider.replace('_', '-')}-status`);
                if (statusElement) {
                    statusElement.className = `status-badge ${config.is_active ? 'status-active' : 'status-inactive'}`;
                    statusElement.textContent = config.is_active ? 'ATTIVO' : 'INATTIVO';
                }
            }
        }

        // Test connessione API
        async function testApiConnection(provider) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="spinner"></div> Testing...';
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'test_connection',
                        provider: provider
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    const testData = result.data;
                    showAlert(`✅ ${provider.toUpperCase()}: ${testData.status} - ${testData.message}`, 'success');
                } else {
                    showAlert(`❌ ${provider.toUpperCase()}: ${result.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ Errore test connessione ${provider}: ${error.message}`, 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Test con container specifico
        async function testWithContainer() {
            const containerNumber = prompt("Inserisci un numero di container per il test (es: MSKU1234567):");
            
            if (!containerNumber) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'track_shipment',
                        tracking_number: containerNumber,
                        provider: 'shipsgo_container'
                    })
                });
                
                const result = await response.json();
                if (result.success && result.data) {
                    showAlert(`✅ Test tracking riuscito per container ${containerNumber}!`, 'success');
                    displayTrackingResults(result.data);
                    
                    // Passa al tab tracking per mostrare risultati
                    showTab('tracking');
                } else {
                    showAlert(`❌ Container ${containerNumber} non trovato o API non raggiungibile`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ Errore test tracking: ${error.message}`, 'danger');
            }
        }

        // Aggiorna configurazione API
        async function updateApiConfig(provider) {
            try {
                let config = {};
                
                switch(provider) {
                    case 'shipsgo_container':
                        config = {
                            auth_code: document.getElementById('shipsgo-container-auth').value,
                            base_url: document.getElementById('shipsgo-container-url').value
                        };
                        break;
                    case 'shipsgo_air':
                        config = {
                            auth_token: document.getElementById('shipsgo-air-token').value,
                            base_url: document.getElementById('shipsgo-air-url').value
                        };
                        break;
                    case 'parcel_app':
                        config = {
                            api_key: document.getElementById('parcel-app-key').value,
                            base_url: document.getElementById('parcel-app-url').value
                        };
                        break;
                }

                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'update_config',
                        provider: provider,
                        config: config
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert(`✅ Configurazione ${provider} aggiornata!`, 'success');
                    loadApiConfiguration();
                } else {
                    showAlert(`❌ Errore aggiornamento: ${result.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ Errore: ${error.message}`, 'danger');
            }
        }

        // Tracking spedizione
        async function trackShipment() {
            const trackingNumber = document.getElementById('tracking-number').value.trim();
            const provider = document.getElementById('tracking-provider').value;
            
            if (!trackingNumber) {
                showAlert('Inserisci un numero di tracking', 'danger');
                return;
            }

            const resultsDiv = document.getElementById('tracking-results');
            resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div>Ricerca in corso...</div>';

            try {
                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'track_shipment',
                        tracking_number: trackingNumber,
                        provider: provider === 'auto' ? null : provider
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    displayTrackingResults(result.data);
                } else {
                    resultsDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle"></i>
                            Nessun risultato trovato per: ${trackingNumber}
                        </div>
                    `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        Errore nella ricerca: ${error.message}
                    </div>
                `;
            }
        }

        // Visualizza risultati tracking
        function displayTrackingResults(data) {
            const resultsDiv = document.getElementById('tracking-results');
            let html = '';

            if (Array.isArray(data)) {
                data.forEach(shipment => {
                    html += createShipmentCard(shipment);
                });
            } else {
                html = createShipmentCard(data);
            }

            resultsDiv.innerHTML = html;
        }

        // Crea card spedizione
        function createShipmentCard(shipment) {
            return `
                <div class="shipment-card">
                    <h4>
                        <i class="fas fa-box"></i>
                        ${shipment.tracking_number || shipment.container_number || 'N/A'}
                        <span class="status-badge ${getStatusClass(shipment.status)}">
                            ${shipment.status || 'Sconosciuto'}
                        </span>
                    </h4>
                    <div class="shipment-details">
                        <div class="detail-item">
                            <div class="detail-label">Origine</div>
                            <div class="detail-value">${shipment.origin || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Destinazione</div>
                            <div class="detail-value">${shipment.destination || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Carrier</div>
                            <div class="detail-value">${shipment.carrier || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Data Spedizione</div>
                            <div class="detail-value">${formatDate(shipment.ship_date)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ETA</div>
                            <div class="detail-value">${formatDate(shipment.eta)}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Provider</div>
                            <div class="detail-value">${shipment.api_source || 'Interno'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-success" onclick="importShipment('${shipment.id || shipment.tracking_number}')">
                            <i class="fas fa-download"></i> Importa in Sistema
                        </button>
                        <button class="btn btn-primary" onclick="viewShipmentDetails('${shipment.id || shipment.tracking_number}')">
                            <i class="fas fa-eye"></i> Dettagli
                        </button>
                    </div>
                </div>
            `;
        }

        // Sincronizzazione spedizioni
        async function syncShipments(type) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="spinner"></div> Sincronizzando...';
            button.disabled = true;

            try {
                let action;
                switch(type) {
                    case 'import':
                        // Sync all providers
                        await Promise.all([
                            syncProvider('shipsgo_air'),
                            syncProvider('parcel_app')
                        ]);
                        break;
                    case 'update':
                        action = 'update_shipments_status';
                        break;
                }

                showAlert(`✅ Sincronizzazione ${type} completata con successo!`, 'success');
                loadStats(); // Ricarica statistiche
                
            } catch (error) {
                showAlert(`❌ Errore sincronizzazione: ${error.message}`, 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Sincronizza provider specifico
        async function syncProvider(provider) {
            let action;
            switch(provider) {
                case 'shipsgo_air':
                    action = 'sync-air-shipments';
                    break;
                case 'parcel_app':
                    action = 'sync-parcel-deliveries';
                    break;
                default:
                    throw new Error(`Provider ${provider} non supportato`);
            }

            const response = await fetch(`${API_BASE_URL}/api-integration`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            });
            
            const result = await response.json();
            if (!result.success) {
                throw new Error(`Errore sync ${provider}: ${result.error}`);
            }
            
            return result;
        }

        // Configura sincronizzazione programmata
        async function configureScheduledSync() {
            const scheduleModal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%;">
                        <h3>Configura Sincronizzazione Automatica</h3>
                        <div class="form-group">
                            <label>Frequenza:</label>
                            <select id="sync-frequency">
                                <option value="hourly">Ogni ora</option>
                                <option value="daily">Giornaliera</option>
                                <option value="weekly">Settimanale</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Providers da sincronizzare:</label>
                            <div>
                                <input type="checkbox" id="sync-shipsgo-air" checked> ShipsGo Air<br>
                                <input type="checkbox" id="sync-parcel" checked> Parcel App<br>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-primary" onclick="saveScheduledSync()">Salva</button>
                            <button class="btn" onclick="closeModal()">Annulla</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', scheduleModal);
        }

        // Salva configurazione sync programmata
        function saveScheduledSync() {
            const frequency = document.getElementById('sync-frequency').value;
            const providers = [];
            
            if (document.getElementById('sync-shipsgo-air').checked) {
                providers.push('shipsgo_air');
            }
            if (document.getElementById('sync-parcel').checked) {
                providers.push('parcel_app');
            }

            showAlert('✅ Sincronizzazione automatica configurata!', 'success');
            closeModal();
        }

        // Mostra log sincronizzazioni
        async function showSyncLogs() {
            const resultsDiv = document.getElementById('sync-results');
            resultsDiv.innerHTML = `
                <div style="background: white; border-radius: 10px; padding: 20px; margin-top: 20px;">
                    <h3>Log Sincronizzazioni</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        <div class="alert alert-info">
                            <strong>2024-05-29 14:30</strong> - Sync ShipsGo Air completata: 15 spedizioni importate
                        </div>
                        <div class="alert alert-success">
                            <strong>2024-05-29 14:25</strong> - Sync Parcel App completata: 8 deliveries aggiornate
                        </div>
                        <div class="alert alert-info">
                            <strong>2024-05-29 13:30</strong> - Sync automatica completata con successo
                        </div>
                        <div class="alert alert-danger">
                            <strong>2024-05-29 12:30</strong> - Errore sync ShipsGo: Rate limit exceeded
                        </div>
                    </div>
                </div>
            `;
        }

        // Chiudi modal
        function closeModal() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }

        // Importa spedizione specifica
        async function importShipment(shipmentId) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="spinner"></div> Importando...';
            button.disabled = true;

            try {
                const response = await fetch(`${API_BASE_URL}/api-integration`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'create-from-tracking',
                        trackingNumber: shipmentId,
                        provider: 'container'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('✅ Spedizione importata con successo!', 'success');
                } else {
                    showAlert(`❌ Errore import: ${result.error}`, 'danger');
                }
            } catch (error) {
                showAlert(`❌ Errore: ${error.message}`, 'danger');
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Visualizza dettagli spedizione
        function viewShipmentDetails(shipmentId) {
            const detailsModal = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
                        <h3>Dettagli Spedizione: ${shipmentId}</h3>
                        <div id="shipment-details-content">
                            <div class="loading">
                                <div class="spinner"></div>
                                Caricamento dettagli...
                            </div>
                        </div>
                        <div style="margin-top: 20px; text-align: right;">
                            <button class="btn btn-primary" onclick="closeModal()">Chiudi</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', detailsModal);
            
            // Simula caricamento dettagli
            setTimeout(() => {
                document.getElementById('shipment-details-content').innerHTML = `
                    <div class="shipment-details">
                        <div class="detail-item">
                            <div class="detail-label">ID Tracking</div>
                            <div class="detail-value">${shipmentId}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Status Attuale</div>
                            <div class="detail-value">In Transito</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Ultima Posizione</div>
                            <div class="detail-value">Port of Hamburg, Germany</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">ETA</div>
                            <div class="detail-value">2024-06-15</div>
                        </div>
                    </div>
                `;
            }, 1000);
        }

        // Carica statistiche
        async function loadStats() {
            try {
                // Simula chiamate API per statistiche
                document.getElementById('total-api-calls').textContent = '1,247';
                document.getElementById('successful-calls').textContent = '1,201';
                document.getElementById('failed-calls').textContent = '46';
                document.getElementById('synced-shipments').textContent = '324';

                // Carica grafico performance
                loadPerformanceChart();
            } catch (error) {
                console.error('Errore caricamento statistiche:', error);
            }
        }

        // Carica grafico performance
        function loadPerformanceChart() {
            const chartDiv = document.getElementById('api-performance-chart');
            chartDiv.innerHTML = `
                <div style="display: flex; justify-content: space-around; text-align: center;">
                    <div>
                        <strong>ShipsGo Container</strong><br>
                        <span style="color: #28a745;">✅ 98.5% Uptime</span>
                    </div>
                    <div>
                        <strong>ShipsGo Air</strong><br>
                        <span style="color: #28a745;">✅ 99.2% Uptime</span>
                    </div>
                    <div>
                        <strong>Parcel App</strong><br>
                        <span style="color: #ffc107;">⚠️ 96.8% Uptime</span>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function getStatusClass(status) {
            const statusClasses = {
                'CONSEGNATO': 'status-active',
                'IN_TRANSITO': 'status-badge',
                'ARRIVATO': 'status-active',
                'SPEDITO': 'status-badge'
            };
            return statusClasses[status] || 'status-inactive';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('it-IT');
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.innerHTML = message;
            
            // Inserisci alert in cima al contenuto attivo
            const activeTab = document.querySelector('.tab-content.active');
            activeTab.insertBefore(alertDiv, activeTab.firstChild);
            
            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
    
    <!-- Include sidebar component -->
    <script src="/components/sidebar.js"></script>
</body>
</html>
