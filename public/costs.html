<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Analisi Costi</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <link rel="stylesheet" href="/solarium.css">
    
    <script src="/auth.js"></script>
    
    <script>
    (function() {
        console.log('[Costs] Checking authentication...');
        
        function checkAuth() {
            if (!window.auth) {
                setTimeout(checkAuth, 100);
                return;
            }
            
            if (!window.auth.isAuthenticated()) {
                console.log('[Costs] Not authenticated, redirecting...');
                window.location.replace('/login.html');
                return;
            }
            
            console.log('[Costs] User authenticated');
            // Update user UI after authentication check
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', updateHeaderUserInfo);
            } else {
                updateHeaderUserInfo();
            }
        }
        
        checkAuth();
    })();

    function updateHeaderUserInfo() { // Moved to global scope for early access by auth script
        const user = window.auth ? window.auth.getCurrentUser() : null;
        if (user) {
            const userNameEl = document.getElementById('userName');
            const userEmailEl = document.getElementById('userEmail'); // For dropdown
            const userInitialEl = document.getElementById('userInitial');
            const userFullNameEl = document.getElementById('userFullName'); // For dropdown

            let displayName = 'Utente';
            let initial = 'U';

            if (user.user_metadata && user.user_metadata.full_name) {
                displayName = user.user_metadata.full_name;
            } else if (user.user_metadata && user.user_metadata.name) {
                displayName = user.user_metadata.name;
            } else if (user.email) {
                displayName = user.email.split('@')[0];
                displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
            }
            
            const words = displayName.split(' ').filter(w => w.length > 0);
            if (words.length >= 2) {
                initial = words[0][0].toUpperCase() + words[1][0].toUpperCase();
            } else if (words.length === 1) {
                initial = words[0][0].toUpperCase();
            }

            if (userNameEl) userNameEl.textContent = displayName;
            if (userInitialEl) userInitialEl.textContent = initial;
            if (userFullNameEl) userFullNameEl.textContent = displayName;
            if (userEmailEl) userEmailEl.textContent = user.email || '';
        }
    }
    </script>
    
    <style>
        /* Page Specific Styles */
        .sol-main-content {
            margin-top: 80px;
            padding: var(--sol-space-xl);
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* KPI Cards Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--sol-space-lg);
            margin-bottom: var(--sol-space-2xl);
        }
        
        .kpi-card {
            background: var(--sol-glass-light);
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--sol-radius-xl);
            padding: var(--sol-space-xl);
            transition: all 0.3s ease;
            /* cursor: pointer;  Sortable.js will handle cursor via handle or draggable item */
        }
        
        .kpi-card:hover { /* Optional: keep hover for non-drag context, or remove if confusing with drag */
            /* transform: translateY(-2px); */
            /* box-shadow: var(--sol-shadow-lg); */
        }

        /* Styles for draggable KPI cards */
        .kpi-card.dragging {
            opacity: 0.7;
            transform: scale(0.98);
            box-shadow: var(--sol-shadow-lg); /* Add shadow to ghost */
        }

        .kpi-card.dragging,
        .kpi-card.sortable-chosen {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            cursor: grabbing !important; /* Indicate dragging */
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sol-space-md);
            cursor: grab; /* Make header the drag handle if desired, or whole card */
        }
        
        .kpi-title {
            font-size: 0.875rem;
            color: var(--sol-text-secondary);
            font-weight: 500;
        }
        
        .kpi-icon {
            width: 40px;
            height: 40px;
            background: var(--sol-gradient-primary);
            border-radius: var(--sol-radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--sol-text-primary);
            margin-bottom: var(--sol-space-sm);
        }
        
        .kpi-change {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .kpi-change.positive {
            color: #34C759;
        }
        
        .kpi-change.negative {
            color: #FF3B30;
        }
        
        /* Filter Bar */
        .filter-bar {
            background: var(--sol-glass-light);
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--sol-radius-xl);
            padding: var(--sol-space-lg);
            margin-bottom: var(--sol-space-2xl);
            display: flex;
            gap: var(--sol-space-md);
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--sol-space-xs);
            flex: 1;
            min-width: 200px;
        }
        
        .filter-label {
            font-size: 0.75rem;
            color: var(--sol-text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: var(--sol-space-lg);
            margin-bottom: var(--sol-space-2xl);
        }
        
        .chart-card {
            background: var(--sol-glass-light);
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--sol-radius-xl);
            padding: var(--sol-space-xl);
            box-shadow: var(--sol-shadow-md);
        }
        
        .chart-card.full-width {
            grid-column: 1 / -1;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--sol-space-lg);
        }
        
        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--sol-text-primary);
        }
        
        .chart-actions {
            display: flex;
            gap: var(--sol-space-sm);
        }
        
        .chart-container {
            width: 100%;
            height: 350px;
        }
        
        /* Comparison Section */
        .comparison-section {
            background: var(--sol-glass-light);
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--sol-radius-xl);
            padding: var(--sol-space-xl);
            margin-bottom: var(--sol-space-2xl);
        }
        
        .budget-bar {
            display: flex;
            align-items: center;
            gap: var(--sol-space-md);
            margin-bottom: var(--sol-space-lg);
        }
        
        .budget-progress {
            flex: 1;
            height: 24px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--sol-radius-full);
            overflow: hidden;
            position: relative;
        }
        
        .budget-fill {
            height: 100%;
            background: var(--sol-gradient-primary);
            border-radius: var(--sol-radius-full);
            transition: width 0.6s ease;
            position: relative;
        }
        
        .budget-fill.warning {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
        }
        
        .budget-fill.danger {
            background: linear-gradient(135deg, #FF3B30 0%, #FF1744 100%);
        }
        
        .budget-label {
            position: absolute;
            right: var(--sol-space-md);
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
        }
        
        /* Data Table */
        .table-section {
            background: var(--sol-glass-light);
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--sol-radius-xl);
            overflow: hidden;
        }
        
        .table-header {
            padding: var(--sol-space-lg) var(--sol-space-xl);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--sol-glass-light); /* Mantenuto come da file originale costs.html */
            backdrop-filter: var(--sol-blur-lg);
            border: 1px solid rgba(255, 255, 255, 0.1); /* Mantenuto */
            padding: var(--sol-space-md);
            text-align: left;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--sol-text-secondary);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: var(--sol-space-md);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--sol-text-primary);
        }
        
        .data-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }
        
        /* Cost Badge */
        .cost-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .cost-badge.high {
            background: rgba(255, 59, 48, 0.15);
            color: #FF3B30;
        }
        
        .cost-badge.medium {
            background: rgba(255, 149, 0, 0.15);
            color: #FF9500;
        }
        
        .cost-badge.low {
            background: rgba(52, 199, 89, 0.15);
            color: #34C759;
        }
        
        /* Export Menu */
        .export-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: var(--sol-space-sm);
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: var(--sol-blur-xl);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--sol-radius-lg);
            padding: var(--sol-space-sm);
            min-width: 180px;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .export-menu.active {
            display: block;
        }
        
        .export-option {
            display: block;
            width: 100%;
            padding: var(--sol-space-sm) var(--sol-space-md);
            color: var(--sol-text-primary);
            text-decoration: none;
            border-radius: var(--sol-radius-sm);
            transition: var(--sol-transition-base);
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .export-option:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Backdrop (per sidebar mobile) */
        .sol-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: var(--sol-blur-sm); /* Corrisponde a dashboard.html */
            z-index: 998; /* Inferiore alla sidebar ma sopra il contenuto */
            opacity: 0;
            visibility: hidden;
            transition: var(--sol-transition-base); /* Corrisponde a dashboard.html */
        }

        .sol-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .filter-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-grid { /* Per coerenza con dashboard, le KPI card su mobile dovrebbero essere full-width */
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table {
                min-width: 600px;
            }
        }
        
        /* Loading State */
        .loading-skeleton {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.05) 25%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(255, 255, 255, 0.05) 75%
            );
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--sol-radius-md);
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Animations */
        .sol-animate-in {
            animation: sol-fade-in 0.6s ease-out;
        }
        
        @keyframes sol-fade-in {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <header class="sol-header" style="overflow: visible;">
        <div class="sol-header-content">
            <div class="sol-header-left" style="display: flex; align-items: center; gap: var(--sol-space-lg);">
                <button class="sol-btn sol-btn-glass" id="menuToggle" style="padding: var(--sol-space-sm);">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/dashboard.html" class="sol-logo">
                    <div class="sol-logo-icon">SCH</div>
                    <span class="sol-logo-text">Supply Chain Hub</span>
                </a>
            </div>
            
            <div class="sol-header-center" style="flex: 1; max-width: 500px; margin: 0 var(--sol-space-xl);">
                <div style="position: relative;">
                    <input type="search" class="sol-search" placeholder="Cerca costi, spedizioni..." style="padding-left: 2.5rem;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--sol-text-tertiary);"></i>
                </div>
            </div>
            
            <div class="sol-header-right" style="display: flex; align-items: center; gap: var(--sol-space-md);">
                <button class="sol-btn sol-btn-glass" id="notificationBtn" style="position: relative; padding: var(--sol-space-sm); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bell" style="font-size: 1.25rem;"></i>
                    <span style="position: absolute; top: 9px; right: 6px; background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%); width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: white; box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);">3</span>
                </button>
                
                <button class="sol-btn sol-btn-glass" id="userMenuBtn" style="display: flex; align-items: center; gap: var(--sol-space-sm);">
                    <div style="width: 32px; height: 32px; background: var(--sol-gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        <span id="userInitial">U</span>
                    </div>
                    <span id="userName">Utente</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div class="sol-dropdown" id="userDropdown" style="position: absolute; top: 70px; right: var(--sol-space-xl); background: rgba(20, 20, 30, 0.95); backdrop-filter: var(--sol-blur-xl); -webkit-backdrop-filter: var(--sol-blur-xl); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--sol-radius-lg); padding: var(--sol-space-sm); min-width: 200px; display: none; z-index: 1000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
                    <div style="padding: var(--sol-space-md); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <p style="font-weight: 600; color: var(--sol-text-primary); margin: 0;" id="userFullName">Nome Utente</p>
                        <p style="font-size: 0.75rem; color: var(--sol-text-secondary); margin: 0; margin-top: 2px;" id="userEmail">email@example.com</p>
                    </div>
                    <a href="/profile.html" class="sol-dropdown-item" style="display: block; padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); text-decoration: none; border-radius: var(--sol-radius-sm); transition: var(--sol-transition-base);">
                        <i class="fas fa-user"></i> Profilo
                    </a>
                    <a href="/settings.html" class="sol-dropdown-item" style="display: block; padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); text-decoration: none; border-radius: var(--sol-radius-sm); transition: var(--sol-transition-base);">
                        <i class="fas fa-cog"></i> Impostazioni
                    </a>
                    <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: var(--sol-space-sm) 0;"></div>
                    <button class="sol-dropdown-item" id="logoutBtn" style="display: block; width: 100%; padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); text-decoration: none; border-radius: var(--sol-radius-sm); transition: var(--sol-transition-base); background: none; border: none; text-align: left; cursor: pointer;">
                        <i class="fas fa-sign-out-alt"></i> Esci
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="sol-dropdown" id="notificationDropdown" style="position: absolute; top: 70px; right: var(--sol-space-xl); background: rgba(20, 20, 30, 0.95); backdrop-filter: var(--sol-blur-xl); -webkit-backdrop-filter: var(--sol-blur-xl); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--sol-radius-lg); min-width: 320px; max-width: 400px; display: none; z-index: 1000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);">
        <div style="padding: var(--sol-space-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Notifiche</h3>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <div class="notification-item" style="padding: var(--sol-space-md) var(--sol-space-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--sol-transition-base);"><div style="display: flex; gap: var(--sol-space-md);"><div style="width: 40px; height: 40px; background: rgba(255, 59, 48, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i class="fas fa-exclamation-triangle" style="color: #FF3B30;"></i></div><div style="flex: 1;"><p style="margin: 0; font-weight: 500; font-size: 0.875rem;">Alert Costo Elevato</p><p style="margin: 0; margin-top: 2px; font-size: 0.75rem; color: var(--sol-text-secondary);">Spedizione ODA-123 supera budget.</p><p style="margin: 0; margin-top: 4px; font-size: 0.75rem; color: var(--sol-text-tertiary);">1 ora fa</p></div></div></div>
            <div class="notification-item" style="padding: var(--sol-space-md) var(--sol-space-lg); cursor: pointer; transition: var(--sol-transition-base);"><div style="display: flex; gap: var(--sol-space-md);"><div style="width: 40px; height: 40px; background: rgba(0, 122, 255, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;"><i class="fas fa-info-circle" style="color: #007AFF;"></i></div><div style="flex: 1;"><p style="margin: 0; font-weight: 500; font-size: 0.875rem;">Nuovo Report Disponibile</p><p style="margin: 0; margin-top: 2px; font-size: 0.75rem; color: var(--sol-text-secondary);">Report costi Q2 pronto.</p><p style="margin: 0; margin-top: 4px; font-size: 0.75rem; color: var(--sol-text-tertiary);">Ieri</p></div></div></div>
        </div>
        <div style="padding: var(--sol-space-md) var(--sol-space-lg); border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
            <a href="/notifications.html" style="color: var(--sol-text-primary); text-decoration: none; font-size: 0.875rem; font-weight: 500;">Vedi tutte le notifiche</a>
        </div>
    </div>

    <aside class="sol-sidebar" id="sidebar">
        <nav style="padding: var(--sol-space-lg) 0;">
            <div style="margin-bottom: var(--sol-space-xl);">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sol-text-tertiary); margin-bottom: var(--sol-space-sm); padding: 0 var(--sol-space-lg);">PRINCIPALE</div>
                <a href="/dashboard.html" class="sol-nav-item"> <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/shipments.html" class="sol-nav-item">
                    <i class="fas fa-box"></i>
                    <span>Spedizioni</span>
                </a>
                <a href="/carriers.html" class="sol-nav-item">
                    <i class="fas fa-truck"></i> <span>Corrieri</span>
                </a>
                <a href="/tracking.html" class="sol-nav-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Tracking</span>
                </a>
            </div>
            
            <div style="margin-bottom: var(--sol-space-xl);">
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sol-text-tertiary); margin-bottom: var(--sol-space-sm); padding: 0 var(--sol-space-lg);">STRUMENTI</div>
                <a href="/import.html" class="sol-nav-item">
                    <i class="fas fa-upload"></i>
                    <span>Importa Dati</span>
                </a>
                <a href="/reports.html" class="sol-nav-item">
                    <i class="fas fa-file-alt"></i>
                    <span>Report</span>
                </a>
                <a href="/costs.html" class="sol-nav-item active"> <i class="fas fa-coins"></i>
                    <span>Analisi Costi</span>
                </a>
            </div>
            
            <div>
                <div style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sol-text-tertiary); margin-bottom: var(--sol-space-sm); padding: 0 var(--sol-space-lg);">CONFIGURAZIONE</div>
                <a href="/team.html" class="sol-nav-item">
                    <i class="fas fa-users"></i>
                    <span>Team</span>
                </a>
                <a href="/settings.html" class="sol-nav-item">
                    <i class="fas fa-cog"></i>
                    <span>Impostazioni</span>
                </a>
                <a href="/billing.html" class="sol-nav-item">
                    <i class="fas fa-credit-card"></i>
                    <span>Fatturazione</span>
                </a>
            </div>
        </nav>
    </aside>

    <main class="sol-main-content">
        <div style="margin-bottom: var(--sol-space-2xl);">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: var(--sol-space-sm);">Analisi Costi</h1>
            <p style="color: var(--sol-text-secondary);">Monitora e analizza i costi di trasporto della tua supply chain</p>
        </div>

        <div class="kpi-grid" id="kpiGridContainer"> <div class="kpi-card sol-animate-in" style="animation-delay: 0.1s;" data-id="totalCostCard">
                <div class="kpi-header"> <h3 class="kpi-title">Costo Totale</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                </div>
                <div class="kpi-value" id="totalCost">€0</div>
                <div class="kpi-change positive">
                    <i class="fas fa-arrow-down"></i>
                    <span id="totalCostChange">0%</span> vs mese precedente
                </div>
            </div>

            <div class="kpi-card sol-animate-in" style="animation-delay: 0.2s;" data-id="avgShipmentCostCard">
                <div class="kpi-header">
                    <h3 class="kpi-title">Costo Medio Spedizione</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-box"></i>
                    </div>
                </div>
                <div class="kpi-value" id="avgShipmentCost">€0</div>
                <div class="kpi-change negative">
                    <i class="fas fa-arrow-up"></i>
                    <span id="avgCostChange">0%</span> vs mese precedente
                </div>
            </div>

            <div class="kpi-card sol-animate-in" style="animation-delay: 0.3s;" data-id="budgetUsedCard">
                <div class="kpi-header">
                    <h3 class="kpi-title">Budget Utilizzato</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                </div>
                <div class="kpi-value" id="budgetUsed">0%</div>
                <div class="kpi-change positive">
                    <i class="fas fa-check-circle"></i>
                    <span id="budgetRemaining">€0</span> rimanenti
                </div>
            </div>

            <div class="kpi-card sol-animate-in" style="animation-delay: 0.4s;" data-id="potentialSavingsCard">
                <div class="kpi-header">
                    <h3 class="kpi-title">Risparmio Potenziale</h3>
                    <div class="kpi-icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                </div>
                <div class="kpi-value" id="potentialSavings">€0</div>
                <div class="kpi-change">
                    <i class="fas fa-info-circle" style="color: #007AFF;"></i>
                    <span style="color: var(--sol-text-secondary);">Ottimizzando i corrieri</span>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group">
                <label class="filter-label">Periodo</label>
                <select class="sol-select" id="periodFilter">
                    <option value="7">Ultimi 7 giorni</option>
                    <option value="30" selected>Ultimi 30 giorni</option>
                    <option value="90">Ultimi 90 giorni</option>
                    <option value="365">Ultimo anno</option>
                    <option value="custom">Personalizzato</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Tipo Spedizione</label>
                <select class="sol-select" id="typeFilter">
                    <option value="">Tutti i tipi</option>
                    <option value="MARE">Mare</option>
                    <option value="AEREO">Aereo</option>
                    <option value="STRADA">Strada</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Spedizioniere</label>
                <select class="sol-select" id="carrierFilter">
                    <option value="">Tutti</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">Fornitore</label>
                <select class="sol-select" id="supplierFilter">
                    <option value="">Tutti</option>
                </select>
            </div>

            <div class="filter-group" style="flex: 0; align-self: flex-end;">
                <button class="sol-btn sol-btn-primary" onclick="applyFilters()">
                    <i class="fas fa-filter"></i>
                    Applica Filtri
                </button>
            </div>
        </div>

        <div class="comparison-section">
            <h2 style="font-size: 1.5rem; margin-bottom: var(--sol-space-lg);">Budget vs Costi Effettivi</h2>
            
            <div class="budget-bar">
                <span style="font-size: 0.875rem; color: var(--sol-text-secondary); min-width: 80px;">Budget:</span>
                <div class="budget-progress">
                    <div class="budget-fill" id="budgetBar" style="width: 0%;">
                        <span class="budget-label" id="budgetLabel">0%</span>
                    </div>
                </div>
                <span style="font-size: 0.875rem; color: var(--sol-text-primary); min-width: 100px; text-align: right;" id="budgetAmount">€0</span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--sol-space-lg); margin-top: var(--sol-space-xl);">
                <div>
                    <p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Budget Mensile</p>
                    <p style="font-size: 1.5rem; font-weight: 700;" id="monthlyBudget">€0</p>
                </div>
                <div>
                    <p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Speso Finora</p>
                    <p style="font-size: 1.5rem; font-weight: 700;" id="spentAmount">€0</p>
                </div>
                <div>
                    <p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Proiezione Fine Mese</p>
                    <p style="font-size: 1.5rem; font-weight: 700;" id="projectedAmount">€0</p>
                </div>
                <div>
                    <p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Stato Budget</p>
                    <p style="font-size: 1.5rem; font-weight: 700;" id="budgetStatus">
                        <span class="cost-badge low">Sotto controllo</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="charts-grid" id="chartsGridContainer"> <div class="chart-card full-width" data-id="costTrendChartCard">
                <div class="chart-header">
                    <h3 class="chart-title">Trend Costi nel Tempo</h3>
                    <div class="chart-actions">
                        <button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('daily')">
                            Giornaliero
                        </button>
                        <button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('weekly')">
                            Settimanale
                        </button>
                        <button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('monthly')">
                            Mensile
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="costTrendChart"></div>
            </div>

            <div class="chart-card" data-id="carrierCostChartCard">
                <div class="chart-header">
                    <h3 class="chart-title">Costi per Spedizioniere</h3>
                    <button class="sol-btn sol-btn-glass" onclick="toggleChartType('carrier')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container" id="carrierCostChart"></div>
            </div>

            <div class="chart-card" data-id="typeCostChartCard">
                <div class="chart-header">
                    <h3 class="chart-title">Costi per Tipo Spedizione</h3>
                    <button class="sol-btn sol-btn-glass" onclick="toggleChartType('type')">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container" id="typeCostChart"></div>
            </div>

            <div class="chart-card" data-id="supplierCostChartCard">
                <div class="chart-header">
                    <h3 class="chart-title">Top 10 Fornitori per Costo</h3>
                    <button class="sol-btn sol-btn-glass" onclick="refreshSupplierChart()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="chart-container" id="supplierCostChart"></div>
            </div>

            <div class="chart-card" data-id="costDistributionChartCard">
                <div class="chart-header">
                    <h3 class="chart-title">Distribuzione Costi</h3>
                    <div style="position: relative;">
                        <button class="sol-btn sol-btn-primary" onclick="toggleExportMenu(event)">
                            <i class="fas fa-download"></i>
                            Export
                        </button>
                        <div class="export-menu" id="exportMenu">
                            <button class="export-option" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i> Export PDF
                            </button>
                            <button class="export-option" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export Excel
                            </button>
                            <button class="export-option" onclick="exportToCSV()">
                                <i class="fas fa-file-csv"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="chart-container" id="costDistributionChart"></div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h3 style="font-size: 1.25rem; font-weight: 600;">Dettaglio Costi Spedizioni</h3>
                <div style="display: flex; gap: var(--sol-space-md);">
                    <input type="search" class="sol-input" placeholder="Cerca..." id="tableSearch" style="width: 250px;">
                    <button class="sol-btn sol-btn-glass" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table class="data-table" id="costsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable('n_oda')" style="cursor: pointer;">
                                N. ODA <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('data_partenza')" style="cursor: pointer;">
                                Data <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('fornitore')" style="cursor: pointer;">
                                Fornitore <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('spedizioniere')" style="cursor: pointer;">
                                Spedizioniere <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('tipo_spedizione')" style="cursor: pointer;">
                                Tipo <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('quantita')" style="cursor: pointer;">
                                Quantità <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('costo_trasporto')" style="cursor: pointer;">
                                Costo Trasporto <i class="fas fa-sort"></i>
                            </th>
                            <th onclick="sortTable('costo_unitario_trasporto')" style="cursor: pointer;"> Costo/Unità <i class="fas fa-sort"></i>
                            </th>
                            <th>Livello Costo</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>
            
            <div style="padding: var(--sol-space-lg); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--sol-text-secondary); font-size: 0.875rem;">
                    Mostrando <span id="showingFrom">0</span>-<span id="showingTo">0</span> di <span id="totalRecords">0</span> righe
                </div>
                <div style="display: flex; gap: var(--sol-space-sm);">
                    <button class="sol-btn sol-btn-glass" onclick="previousPage()" id="prevBtn" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <span style="padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary);">
                        Pagina <span id="currentPage">1</span> di <span id="totalPages">1</span>
                    </span>
                    <button class="sol-btn sol-btn-glass" onclick="nextPage()" id="nextBtn">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div class="sol-backdrop" id="backdrop"></div> <script>
        // Global variables specific to costs.html
        let costsData = [];
        let filteredData = [];
        let chartInstances = {}; // Per istanze grafici specifiche di questa pagina
        let currentPage = 1;
        const recordsPerPage = 20;
        let sortColumn = 'data_partenza';
        let sortDirection = 'desc';
        let kpiSortableInstance = null; // Istanza Sortable per KPI cards

        // Chart theme (identico a dashboard.html per coerenza)
        const chartTheme = {
            theme: { mode: 'dark' },
            chart: {
                background: 'transparent',
                toolbar: { show: false },
                fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif',
                animations: {
                    enabled: true,
                    easing: 'easeinout',
                    speed: 800
                }
            },
            grid: {
                borderColor: 'rgba(255, 255, 255, 0.1)',
                strokeDashArray: 0
            },
            colors: ['#007AFF', '#5856D6', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#FF2D55', '#00C7BE'],
            dataLabels: { enabled: false },
            stroke: { curve: 'smooth', width: 3 },
            xaxis: {
                labels: { style: { colors: 'rgba(255, 255, 255, 0.5)' } },
                axisBorder: { show: false },
                axisTicks: { show: false }
            },
            yaxis: {
                labels: { 
                    style: { colors: 'rgba(255, 255, 255, 0.5)' },
                    formatter: (val) => formatCurrency(val) // Usa la funzione globale
                }
            },
            legend: {
                labels: { colors: 'rgba(255, 255, 255, 0.7)' }
            },
            tooltip: {
                theme: 'dark',
                style: { fontSize: '12px' }
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupGlobalHeaderListeners(); // Per header, sidebar, notifiche, user menu
            setupPageSpecificEventListeners(); // Per filtri, tabelle etc. di costs.html
            loadCostsData();
            // updateUserInfo() è già chiamata dallo script di protezione pagina
            setupDraggableCards(); // Inizializza drag-and-drop per le card
        });

        // Funzioni globali per formattazione (possono essere messe in un file utils.js comune)
        function formatCurrency(value, decimals = 0) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function formatNumber(value, decimals = 0) {
            if (typeof value !== 'number') value = parseFloat(value) || 0;
            return new Intl.NumberFormat('it-IT', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }
        
        // --- INIZIO FUNZIONI PER HEADER & SIDEBAR (da dashboard.html) ---
        function setupGlobalHeaderListeners() {
            // Menu toggle
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('backdrop');
            
            if (menuToggle && sidebar && backdrop) {
                menuToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.toggle('active');
                    backdrop.classList.toggle('active');
                    document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
                });

                backdrop.addEventListener('click', function() {
                    sidebar.classList.remove('active');
                    backdrop.classList.remove('active');
                    document.body.style.overflow = '';
                });
            }

            // User dropdown
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');

            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Chiudi notification dropdown se aperto
                    const notificationDropdown = document.getElementById('notificationDropdown');
                    if (notificationDropdown) notificationDropdown.style.display = 'none';
                    userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none';
                });
                
                userDropdown.addEventListener('click', function(e) { // Evita chiusura cliccando dentro
                    e.stopPropagation();
                });
            }
            
            // Notification dropdown
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    // Chiudi user dropdown se aperto
                    if (userDropdown) userDropdown.style.display = 'none';
                    notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none';
                });
            }

            // Chiudi entrambi i dropdown cliccando fuori
            document.addEventListener('click', function(e) {
                if (userDropdown && userDropdown.style.display !== 'none' && 
                    userMenuBtn && !userMenuBtn.contains(e.target) && 
                    !userDropdown.contains(e.target)) {
                    userDropdown.style.display = 'none';
                }
                if (notificationDropdown && notificationDropdown.style.display !== 'none' && 
                    notificationBtn && !notificationBtn.contains(e.target) && 
                    !notificationDropdown.contains(e.target)) {
                    notificationDropdown.style.display = 'none';
                }
            });

            // Logout (già presente nel dropdown HTML, ma assicuriamoci che l'ID sia corretto)
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.auth && window.auth.logout) {
                        window.auth.logout();
                    } else { // Fallback se auth.js non è caricato correttamente
                        localStorage.removeItem('sb-access-token');
                        localStorage.removeItem('supabase.auth.token'); // Aggiunto per completezza
                        localStorage.removeItem('user');
                        window.location.replace('/login.html');
                    }
                });
            }
        }
        // --- FINE FUNZIONI PER HEADER & SIDEBAR ---


        // Setup page specific event listeners
        function setupPageSpecificEventListeners() {
            // Table search
            const tableSearchEl = document.getElementById('tableSearch');
            if (tableSearchEl) {
                tableSearchEl.addEventListener('input', debounce(function(e) {
                    const searchTerm = e.target.value.toLowerCase();
                    filterTableData(searchTerm);
                }, 300));
            }

            // Period filter custom date
            const periodFilterEl = document.getElementById('periodFilter');
            if (periodFilterEl) {
                periodFilterEl.addEventListener('change', function(e) {
                    if (e.target.value === 'custom') {
                        showDatePickerModal(); // Da implementare se necessario
                    } else {
                        applyFilters();
                    }
                });
            }

            // Altri filtri
            ['typeFilter', 'carrierFilter', 'supplierFilter'].forEach(filterId => {
                const filterEl = document.getElementById(filterId);
                if (filterEl) {
                    filterEl.addEventListener('change', applyFilters);
                }
            });
        }
        
        // Setup draggable KPI cards
        function setupDraggableCards() {
            const kpiGridContainer = document.getElementById('kpiGridContainer');
            if (kpiGridContainer && window.Sortable) {
                kpiSortableInstance = new Sortable(kpiGridContainer, {
                    animation: 150,
                    ghostClass: 'dragging', // Applica la classe .kpi-card.dragging
                    draggable: '.kpi-card', // Specifica quali elementi sono trascinabili
                    // handle: '.kpi-header', // Opzionale: se vuoi che solo l'header sia l'handle
                    forceFallback: true,
                    onEnd: function (evt) {
                        console.log('KPI Card order changed (costs.html):', evt.oldIndex, '->', evt.newIndex);
                        // Qui potresti salvare l'ordine in localStorage se necessario per questa pagina
                        // const newOrder = Array.from(evt.to.children).map(card => card.dataset.id);
                        // localStorage.setItem('costsKpiOrder', JSON.stringify(newOrder));
                    }
                });
            }
            // Potresti aggiungere logica simile per .charts-grid se necessario
        }


        // Load costs data
        async function loadCostsData() {
            // Mostra scheletri di caricamento
            showLoadingSkeletons(true);

            try {
                const token = localStorage.getItem('sb-access-token') || localStorage.getItem('supabase.auth.token');
                const periodFilter = document.getElementById('periodFilter');
                const period = periodFilter ? periodFilter.value : '30';
                
                const response = await fetch(`/.netlify/functions/get-costs?period=${period}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    // Se API fallisce, carica dati mock E mostra un errore
                    console.error('Failed to load costs data, status:', response.status);
                    showNotification('Errore nel caricamento dei dati, verranno mostrati dati di esempio.', 'error');
                    loadMockData(); // Carica mock data come fallback
                    return; 
                }
                
                const data = await response.json();
                
                if (!data || !data.shipments) { // Controllo aggiuntivo per la struttura dei dati
                     console.error('Received invalid data structure from API');
                     showNotification('Dati ricevuti non validi, verranno mostrati dati di esempio.', 'error');
                     loadMockData();
                     return;
                }

                costsData = data.shipments || [];
                
                // Applica i filtri correnti ai dati caricati
                applyFiltersAndRender(); // Funzione modificata per gestire tutto il rendering
                populateFilters(); // Popola i filtri con i dati freschi
                
            } catch (error) {
                console.error('Error loading costs:', error);
                showNotification('Errore critico nel caricamento dei dati, verranno mostrati dati di esempio.', 'error');
                loadMockData(); // Carica mock data come fallback
            } finally {
                showLoadingSkeletons(false); // Nascondi scheletri
            }
        }

        function applyFiltersAndRender() {
            // Applica filtri basati sui select attuali
            const type = document.getElementById('typeFilter').value;
            const carrier = document.getElementById('carrierFilter').value;
            const supplier = document.getElementById('supplierFilter').value;
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();

            filteredData = costsData.filter(item => {
                const matchesType = !type || item.tipo_spedizione === type;
                const matchesCarrier = !carrier || item.spedizioniere === carrier;
                const matchesSupplier = !supplier || item.fornitore === supplier;
                
                const matchesSearch = !searchTerm || 
                    Object.values(item).some(val => 
                        String(val).toLowerCase().includes(searchTerm)
                    );
                
                return matchesType && matchesCarrier && matchesSupplier && matchesSearch;
            });
            
            // Calcola KPIs basati sui dati filtrati (o su tutti i dati se i KPI non devono cambiare con i filtri)
            // Se i KPI devono riflettere i dati originali, passa costsData
            // Se devono riflettere i dati filtrati, calcola KPIs su filteredData
            const kpiSourceData = costsData; // Assumiamo che i KPI si basino sui dati del periodo, non sui filtri tabella
            
            const kpis = calculateKPIs(kpiSourceData); // Funzione helper per calcolare KPI
            const budgetInfo = calculateBudgetInfo(kpiSourceData, 150000); // Esempio di budget mensile

            updateKPIs(kpis);
            updateBudgetComparison(budgetInfo);
            updateCharts(); // I grafici dovrebbero usare filteredData
            updateTable();  // La tabella usa filteredData e paginazione
        }

        function calculateKPIs(dataToProcess) {
            const totalCost = dataToProcess.reduce((sum, s) => sum + (s.costo_trasporto || 0), 0);
            const avgShipmentCost = dataToProcess.length > 0 ? totalCost / dataToProcess.length : 0;
            // Calcola variazioni vs periodo precedente (semplificato, richiederebbe fetch separata)
            const totalCostChange = -5.0; // Esempio
            const avgCostChange = 2.1;   // Esempio
            const potentialSavings = totalCost * 0.08; // Esempio 8%

            return {
                totalCost,
                totalCostChange,
                avgShipmentCost,
                avgCostChange,
                shipmentCount: dataToProcess.length,
                // budgetUsed e budgetRemaining verranno da calculateBudgetInfo
                potentialSavings 
            };
        }
        
        function calculateBudgetInfo(dataToProcess, monthlyBudget) {
            const totalSpentInPeriod = dataToProcess.reduce((sum, s) => sum + (s.costo_trasporto || 0), 0);
            // Per una vera analisi del budget, dovresti considerare il periodo selezionato
            // e rapportarlo al budget mensile. Qui semplifichiamo.
            const budgetUsedPercentage = Math.min(Math.round((totalSpentInPeriod / monthlyBudget) * 100), 100);
            const budgetRemaining = Math.max(monthlyBudget - totalSpentInPeriod, 0);
            // Proiezione semplificata, assumendo che i costi del periodo siano per l'intero mese
            const projectedMonthTotal = totalSpentInPeriod; 

            return {
                monthly: monthlyBudget,
                spent: totalSpentInPeriod,
                projected: projectedMonthTotal,
                percentage: budgetUsedPercentage,
                remaining: budgetRemaining
            };
        }


        function showLoadingSkeletons(isLoading) {
            const kpiValues = document.querySelectorAll('.kpi-value, .kpi-change span:first-child');
            const chartContainers = document.querySelectorAll('.chart-container');
            const tableBody = document.getElementById('tableBody');

            if (isLoading) {
                kpiValues.forEach(el => {
                    el.classList.add('loading-skeleton');
                    el.style.minHeight = '2rem'; // Per dare altezza allo scheletro
                    el.textContent = ''; // Pulisci testo
                });
                chartContainers.forEach(el => {
                    el.innerHTML = '<div class="loading-skeleton" style="width:100%; height:100%;"></div>';
                });
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center;"><div class="loading-skeleton" style="width:80%; height:200px; margin:auto;"></div></td></tr>`;
            } else {
                kpiValues.forEach(el => {
                    el.classList.remove('loading-skeleton');
                    el.style.minHeight = '';
                });
                // I grafici e la tabella verranno ripopolati dalle loro funzioni di update
            }
        }

        // Load mock data
        function loadMockData() {
            const mock = generateMockCostsData();
            costsData = mock.shipments;
            
            const kpis = mock.kpis;
            kpis.budgetUsed = mock.budget.percentage; // Aggiungi questi se mancanti in mock.kpis
            kpis.budgetRemaining = mock.budget.remaining || (mock.budget.monthly - mock.budget.spent);

            updateKPIs(kpis);
            updateBudgetComparison(mock.budget);
            
            applyFiltersAndRender(); // Usa la funzione unificata
            populateFilters();
        }

        // Generate mock costs data
        function generateMockCostsData() {
            const carriers = ['DHL', 'FedEx', 'UPS', 'TNT', 'GLS', 'Schenker', 'Maersk'];
            const types = ['MARE', 'AEREO', 'STRADA'];
            const suppliers = ['Supplier Alpha', 'Beta Goods', 'Gamma Inc', 'Delta Corp', 'Epsilon LLC'];
            const shipments = [];
            const numShipments = Math.floor(Math.random() * 100) + 50; // Tra 50 e 150
            
            for (let i = 0; i < numShipments; i++) {
                const quantity = Math.floor(Math.random() * 500) + 10;
                const baseCost = Math.random() * 1500 + 100;
                const type = types[Math.floor(Math.random() * types.length)];
                let costMultiplier = 1;
                if (type === 'AEREO') costMultiplier = 2 + Math.random();
                else if (type === 'MARE') costMultiplier = 0.5 + Math.random() * 0.5;
                else costMultiplier = 0.8 + Math.random() * 0.4;

                const costo_trasporto = Math.round((baseCost * costMultiplier) * 100) / 100;
                
                shipments.push({
                    n_oda: `ODA-MOCK-${String(2000 + i).padStart(4, '0')}`,
                    cod_art: `ART-M${String(Math.floor(Math.random()*500)+100).padStart(3,'0')}`,
                    data_partenza: new Date(Date.now() - Math.random() * 60 * 24 * 60 * 60 * 1000).toISOString(), // Ultimi 60 giorni
                    fornitore: suppliers[Math.floor(Math.random() * suppliers.length)],
                    spedizioniere: carriers[Math.floor(Math.random() * carriers.length)],
                    tipo_spedizione: type,
                    quantita: quantity,
                    costo_trasporto: costo_trasporto,
                    costo_unitario_trasporto: Math.round((costo_trasporto / quantity) * 100) / 100,
                    stato_spedizione: ['Consegnato', 'In transito', 'In ritardo'][Math.floor(Math.random()*3)]
                });
            }
            
            const totalCost = shipments.reduce((sum, s) => sum + (s.costo_trasporto || 0), 0);
            const avgShipmentCost = shipments.length > 0 ? totalCost / shipments.length : 0;
            const monthlyBudget = 150000;
            const budgetSpent = totalCost; // Semplificato per mock, assumendo periodo = 1 mese
            const budgetPercentage = Math.min(Math.round((budgetSpent / monthlyBudget) * 100),100);
            
            return {
                shipments,
                kpis: {
                    totalCost,
                    totalCostChange: (Math.random() * 20 - 10), // +/- 10%
                    avgShipmentCost,
                    avgCostChange: (Math.random() * 10 - 5), // +/- 5%
                    budgetUsed: budgetPercentage,
                    budgetRemaining: Math.max(0, monthlyBudget - budgetSpent),
                    potentialSavings: totalCost * (Math.random() * 0.05 + 0.05), // 5-10%
                    shipmentCount: shipments.length
                },
                budget: {
                    monthly: monthlyBudget,
                    spent: budgetSpent,
                    projected: budgetSpent * (1 + (Math.random() * 0.2 - 0.1)), // +/- 10% proiezione
                    percentage: budgetPercentage,
                    remaining: Math.max(0, monthlyBudget - budgetSpent)
                }
            };
        }

        // Update KPIs
        function updateKPIs(kpis) {
            if (!kpis) return;
            document.getElementById('totalCost').textContent = formatCurrency(kpis.totalCost);
            
            const totalCostChangeElText = document.getElementById('totalCostChange');
            const totalCostChangeIconParent = totalCostChangeElText ? totalCostChangeElText.parentElement : null;
            if (totalCostChangeElText && totalCostChangeIconParent) {
                totalCostChangeElText.textContent = Math.abs(kpis.totalCostChange || 0).toFixed(1) + '%';
                totalCostChangeIconParent.className = (kpis.totalCostChange || 0) < 0 ? 'kpi-change positive' : 'kpi-change negative';
                totalCostChangeIconParent.querySelector('i').className = `fas fa-arrow-${(kpis.totalCostChange || 0) < 0 ? 'down' : 'up'}`;
            }
            
            document.getElementById('avgShipmentCost').textContent = formatCurrency(kpis.avgShipmentCost);
            const avgCostChangeElText = document.getElementById('avgCostChange');
            const avgCostChangeIconParent = avgCostChangeElText ? avgCostChangeElText.parentElement : null;

            if (avgCostChangeElText && avgCostChangeIconParent) {
                avgCostChangeElText.textContent = Math.abs(kpis.avgCostChange || 0).toFixed(1) + '%';
                avgCostChangeIconParent.className = (kpis.avgCostChange || 0) < 0 ? 'kpi-change positive' : 'kpi-change negative';
                avgCostChangeIconParent.querySelector('i').className = `fas fa-arrow-${(kpis.avgCostChange || 0) < 0 ? 'down' : 'up'}`;
            }
            
            document.getElementById('budgetUsed').textContent = (kpis.budgetUsed || kpis.percentage || 0) + '%'; // Usa kpis.percentage se kpis.budgetUsed non c'è
            document.getElementById('budgetRemaining').textContent = formatCurrency(kpis.budgetRemaining || 0);
            document.getElementById('potentialSavings').textContent = formatCurrency(kpis.potentialSavings || 0);
        }

        // Update budget comparison
        function updateBudgetComparison(budget) {
            if (!budget) return;
            const percentage = budget.percentage || 0;
            const budgetBar = document.getElementById('budgetBar');
            const budgetLabel = document.getElementById('budgetLabel');
            
            if (budgetBar) budgetBar.style.width = percentage + '%';
            if (budgetLabel) budgetLabel.textContent = percentage + '%';
            
            if (budgetBar) {
                if (percentage > 90) budgetBar.className = 'budget-fill danger';
                else if (percentage > 75) budgetBar.className = 'budget-fill warning';
                else budgetBar.className = 'budget-fill';
            }
            
            document.getElementById('monthlyBudget').textContent = formatCurrency(budget.monthly);
            document.getElementById('spentAmount').textContent = formatCurrency(budget.spent);
            document.getElementById('projectedAmount').textContent = formatCurrency(budget.projected);
            
            const statusEl = document.getElementById('budgetStatus');
            if (statusEl) {
                if (percentage > 90) statusEl.innerHTML = '<span class="cost-badge high">Oltre budget</span>';
                else if (percentage > 75) statusEl.innerHTML = '<span class="cost-badge medium">Attenzione</span>';
                else statusEl.innerHTML = '<span class="cost-badge low">Sotto controllo</span>';
            }
            document.getElementById('budgetAmount').textContent = formatCurrency(budget.monthly);
        }

        // Update all charts
        function updateCharts() {
            updateCostTrendChart();
            updateCarrierCostChart();
            updateTypeCostChart();
            updateSupplierCostChart();
            updateCostDistributionChart();
        }

        // Update cost trend chart
        function updateCostTrendChart(aggregationPeriod = 'daily') {
            const chartData = prepareTrendData(aggregationPeriod);
            const options = { /* ... (opzioni come prima, ma usa chartData) ... */ 
                ...chartTheme,
                series: [{ name: 'Costo Trasporto', data: chartData }],
                chart: { ...chartTheme.chart, type: 'area', height: 350 },
                xaxis: { ...chartTheme.xaxis, type: 'datetime' },
                fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] }}
            };
            renderOrUpdateChart('costTrend', "#costTrendChart", options);
        }

        // Update carrier cost chart
        function updateCarrierCostChart() {
            const carrierData = aggregateByCarrier();
            const options = { /* ... (opzioni come prima) ... */ 
                ...chartTheme, series: carrierData.values, labels: carrierData.labels,
                chart: { ...chartTheme.chart, type: 'donut', height: 350 },
                plotOptions: { pie: { donut: { size: '65%' }}},
                responsive: [{ breakpoint: 480, options: { chart: { width: 300 }, legend: { position: 'bottom' }}}]
            };
            renderOrUpdateChart('carrierCost', "#carrierCostChart", options, true);
        }

        // Update type cost chart
        function updateTypeCostChart() {
            const typeData = aggregateByType();
            const options = { /* ... (opzioni come prima) ... */ 
                ...chartTheme, series: [{ name: 'Costo', data: typeData.values }],
                chart: { ...chartTheme.chart, type: 'bar', height: 350 },
                xaxis: { ...chartTheme.xaxis, categories: typeData.labels },
                plotOptions: { bar: { borderRadius: 8, dataLabels: { position: 'top' }}}
            };
            renderOrUpdateChart('typeCost', "#typeCostChart", options, true);
        }

        // Update supplier cost chart
        function updateSupplierCostChart() {
            const supplierData = aggregateBySupplier();
            const options = { /* ... (opzioni come prima) ... */ 
                ...chartTheme, series: [{ name: 'Costo Trasporto', data: supplierData.values.slice(0, 10) }],
                chart: { ...chartTheme.chart, type: 'bar', height: 350 },
                xaxis: { ...chartTheme.xaxis, categories: supplierData.labels.slice(0, 10) },
                plotOptions: { bar: { horizontal: true, borderRadius: 4 }}
            };
            renderOrUpdateChart('supplierCost', "#supplierCostChart", options, true);
        }

        // Update cost distribution chart
        function updateCostDistributionChart() {
            const distribution = calculateCostDistribution();
            const options = { /* ... (opzioni come prima) ... */ 
                ...chartTheme, series: distribution.values, labels: distribution.labels,
                chart: { ...chartTheme.chart, type: 'pie', height: 350 },
                legend: { position: 'right' }
            };
            renderOrUpdateChart('costDistribution', "#costDistributionChart", options, true);
        }

        function renderOrUpdateChart(instanceKey, querySelector, options, forceRecreate = false) {
            const chartEl = document.querySelector(querySelector);
            if (!chartEl) return;

            if (chartInstances[instanceKey] && !forceRecreate) {
                chartInstances[instanceKey].updateOptions(options);
            } else {
                if (chartInstances[instanceKey]) chartInstances[instanceKey].destroy();
                chartInstances[instanceKey] = new ApexCharts(chartEl, options);
                chartInstances[instanceKey].render();
            }
        }


        // Data aggregation functions
        function prepareTrendData(period) { /* ... (come prima) ... */ 
            const grouped = {};
            filteredData.forEach(item => {
                const date = new Date(item.data_partenza);
                let key;
                if (period === 'daily') key = date.toISOString().split('T')[0];
                else if (period === 'weekly') {
                    const d = new Date(date);
                    d.setDate(d.getDate() - d.getDay() + (d.getDay() === 0 ? -6 : 1)); // Lunedì come inizio settimana
                    key = d.toISOString().split('T')[0];
                } else key = `<span class="math-inline">\{date\.getFullYear\(\)\}\-</span>{String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!grouped[key]) grouped[key] = 0;
                grouped[key] += (item.costo_trasporto || 0);
            });
            return Object.entries(grouped).sort(([a], [b]) => new Date(a) - new Date(b)).map(([date, value]) => ({ x: new Date(date).getTime(), y: Math.round(value) }));
        }
        function aggregateByCarrier() { /* ... (come prima, usa filteredData) ... */ 
            const grouped = {};
            filteredData.forEach(item => {
                const carrier = item.spedizioniere || 'N/D';
                if (!grouped[carrier]) grouped[carrier] = 0;
                grouped[carrier] += (item.costo_trasporto || 0);
            });
            const sorted = Object.entries(grouped).sort(([,a], [,b]) => b - a);
            return { labels: sorted.map(([label]) => label), values: sorted.map(([, cost]) => Math.round(cost))};
        }
        function aggregateByType() { /* ... (come prima, usa filteredData) ... */ 
            const grouped = {};
            filteredData.forEach(item => {
                const type = item.tipo_spedizione || 'N/D';
                if (!grouped[type]) grouped[type] = 0;
                grouped[type] += (item.costo_trasporto || 0);
            });
            return { labels: Object.keys(grouped), values: Object.values(grouped).map(v => Math.round(v))};
        }
        function aggregateBySupplier() { /* ... (come prima, usa filteredData) ... */ 
            const grouped = {};
            filteredData.forEach(item => {
                const supplier = item.fornitore || 'N/D';
                if (!grouped[supplier]) grouped[supplier] = 0;
                grouped[supplier] += (item.costo_trasporto || 0);
            });
            const sorted = Object.entries(grouped).sort(([,a], [,b]) => b - a);
            return { labels: sorted.map(([label]) => label), values: sorted.map(([, cost]) => Math.round(cost))};
        }
        function calculateCostDistribution() { /* ... (come prima, usa filteredData) ... */ 
            const ranges = { '< €500': 0, '€500-€1k': 0, '€1k-€2k': 0, '€2k-€5k': 0, '> €5k': 0 };
            filteredData.forEach(item => {
                const cost = item.costo_trasporto || 0;
                if (cost < 500) ranges['< €500']++;
                else if (cost < 1000) ranges['€500-€1k']++;
                else if (cost < 2000) ranges['€1k-€2k']++;
                else if (cost < 5000) ranges['€2k-€5k']++;
                else ranges['> €5k']++;
            });
            return { labels: Object.keys(ranges), values: Object.values(ranges)};
        }


        // Update table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            if (!tbody) return;
            tbody.innerHTML = ''; // Pulisci prima
            
            // Sort data
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                
                // Gestione per data
                if (sortColumn === 'data_partenza') {
                    aVal = new Date(aVal).getTime();
                    bVal = new Date(bVal).getTime();
                } else if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                } else if (typeof aVal === 'number' && typeof bVal === 'number') {
                    // No transformation needed for numbers
                } else { // Fallback per tipi misti o null/undefined
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            // Pagination logic
            const totalRecords = sortedData.length;
            const totalPages = Math.ceil(totalRecords / recordsPerPage);
            currentPage = Math.min(currentPage, totalPages) || 1; // Assicura che currentPage non sia invalida

            const startRecord = (currentPage - 1) * recordsPerPage;
            const endRecord = startRecord + recordsPerPage;
            const paginatedData = sortedData.slice(startRecord, endRecord);

            if (paginatedData.length === 0 && totalRecords > 0) { // Se la pagina corrente è vuota ma ci sono dati
                 tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: var(--sol-space-xl);">Nessun dato per questa pagina.</td></tr>`;
            } else if (totalRecords === 0) {
                 tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: var(--sol-space-xl);">Nessun dato trovato per i filtri selezionati.</td></tr>`;
            } else {
                paginatedData.forEach(item => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = item.n_oda || '-';
                    row.insertCell().textContent = item.data_partenza ? new Date(item.data_partenza).toLocaleDateString('it-IT') : '-';
                    row.insertCell().textContent = item.fornitore || '-';
                    row.insertCell().textContent = item.spedizioniere || '-';
                    row.insertCell().textContent = item.tipo_spedizione || '-';
                    row.insertCell().textContent = formatNumber(item.quantita || 0);
                    row.insertCell().textContent = formatCurrency(item.costo_trasporto || 0);
                    row.insertCell().textContent = formatCurrency(item.costo_unitario_trasporto || 0, 2); // Mostra sempre 2 decimali per costo unitario
                    
                    // Cost level badge
                    const cost = item.costo_trasporto || 0;
                    let badgeClass = 'low';
                    if (cost > 2000) badgeClass = 'high';
                    else if (cost > 500) badgeClass = 'medium';
                    row.insertCell().innerHTML = `<span class="cost-badge <span class="math-inline">\{badgeClass\}"\></span>{badgeClass.toUpperCase()}</span>`;
                });
            }

            // Update pagination info
            document.getElementById('showingFrom').textContent = totalRecords > 0 ? startRecord + 1 : 0;
            document.getElementById('showingTo').textContent = Math.min(endRecord, totalRecords);
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = totalPages > 0 ? totalPages : 1;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
            
            // Update sort icons
            document.querySelectorAll('.data-table th i.fa-sort').forEach(icon => {
                icon.className = 'fas fa-sort'; // Reset
            });
            const activeSortTh = document.querySelector(`.data-table th[onclick="sortTable('${sortColumn}')"] i`);
            if (activeSortTh) {
                activeSortTh.className = `fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}`;
            }
        }
        
        // Sort table
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc'; // Default a asc per nuova colonna
            }
            currentPage = 1; // Reset a pagina 1 quando si cambia ordinamento
            updateTable();
        }

        // Populate filters
        function populateFilters() {
            const carriers = [...new Set(costsData.map(item => item.spedizioniere).filter(Boolean))].sort();
            const suppliers = [...new Set(costsData.map(item => item.fornitore).filter(Boolean))].sort();
            
            const carrierFilter = document.getElementById('carrierFilter');
            const supplierFilter = document.getElementById('supplierFilter');
            
            // Salva i valori selezionati
            const selectedCarrier = carrierFilter.value;
            const selectedSupplier = supplierFilter.value;

            carrierFilter.innerHTML = '<option value="">Tutti</option>'; // Reset e aggiungi opzione default
            carriers.forEach(c => {
                const option = document.createElement('option');
                option.value = c;
                option.textContent = c;
                carrierFilter.appendChild(option);
            });
            
            supplierFilter.innerHTML = '<option value="">Tutti</option>'; // Reset e aggiungi opzione default
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                supplierFilter.appendChild(option);
            });

            // Ripristina i valori selezionati se esistono ancora nelle opzioni
            if (carriers.includes(selectedCarrier)) carrierFilter.value = selectedCarrier;
            if (suppliers.includes(selectedSupplier)) supplierFilter.value = selectedSupplier;
        }

        // Apply filters
        function applyFilters() {
            currentPage = 1; // Reset a pagina 1 quando si applicano i filtri
            applyFiltersAndRender();
        }
        
        // Filter table data by search term (non ricarica i dati, filtra quelli esistenti)
        function filterTableData(searchTerm) {
            applyFiltersAndRender(); // La logica di search è già in applyFiltersAndRender
        }

        // Debounce function
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Pagination
        function nextPage() {
            const totalPages = Math.ceil(filteredData.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        }
        
        // Export functions
        function toggleExportMenu(event) {
            event.stopPropagation(); // Previene la chiusura immediata dal document click listener
            document.getElementById('exportMenu').classList.toggle('active');
        }

        async function exportData(format) {
            showNotification(`Esportazione ${format.toUpperCase()} in corso...`, 'info');
            try {
                const token = localStorage.getItem('sb-access-token') || localStorage.getItem('supabase.auth.token');
                const period = document.getElementById('periodFilter').value;
                const type = document.getElementById('typeFilter').value;
                const carrier = document.getElementById('carrierFilter').value;
                const supplier = document.getElementById('supplierFilter').value;

                // Usare filteredData se si vogliono esportare i dati come visualizzati
                // o fare una nuova chiamata API per esportare tutti i dati con i filtri server-side
                // Per ora, usiamo filteredData
                const dataToExport = {
                    shipments: filteredData, // Esporta i dati attualmente filtrati nella UI
                    filters: { period, tipo_spedizione: type, spedizioniere: carrier, fornitore: supplier },
                    // period: { start: ..., end: ... } // Potrebbe essere utile passare il range esatto
                };

                const response = await fetch('/.netlify/functions/export-costs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ format, data: dataToExport }) // Passa i dati filtrati
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Export ${format.toUpperCase()} fallito`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analisi-costi-<span class="math-inline">\{new Date\(\)\.toISOString\(\)\.split\('T'\)\[0\]\}\.</span>{format}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                showNotification(`Export ${format.toUpperCase()} completato!`, 'success');

            } catch (error) {
                console.error(`Error exporting to ${format}:`, error);
                showNotification(`Errore export ${format.toUpperCase()}: ${error.message}`, 'error');
            }
            document.getElementById('exportMenu').classList.remove('active');
        }
        
        window.exportToPDF = () => exportData('pdf');
        window.exportToExcel = () => exportData('excel');
        window.exportToCSV = () => exportData('csv');
        
        // Helper function: Show notification (se non è già globale)
        if (!window.showNotification) {
            window.showNotification = function(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `sol-notification sol-notification-${type} sol-animate-in`;
                // Stili base per la notifica (possono essere in CSS)
                notification.style.cssText = `position:fixed;top:20px;right:20px;padding:15px;background:var(--sol-glass-heavy);color:var(--sol-text-primary);border-radius:8px;z-index:1001;border:1px solid var(--sol-border);backdrop-filter:blur(10px);box-shadow:var(--sol-shadow-md);`;
                if (type === 'error') notification.style.borderColor = 'var(--sol-gradient-error)';
                if (type === 'success') notification.style.borderColor = 'var(--sol-gradient-success)';
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }
        }
        // Funzione refreshTable (se serve per ricaricare da zero, altrimenti applyFilters è sufficiente)
        function refreshTable(){
            loadCostsData(); // Ricarica tutti i dati e riapplica i filtri
            showNotification('Tabella aggiornata.', 'info');
        }
        // Funzione showDatePickerModal (placeholder)
        function showDatePickerModal(){
            showNotification('Selezione periodo personalizzato non ancora implementata.', 'info');
        }
        // Funzione toggleChartType (placeholder)
        function toggleChartType(chartName){
            showNotification(`Toggle tipo grafico per ${chartName} non ancora implementato.`, 'info');
        }
        // Funzione refreshSupplierChart (placeholder)
        function refreshSupplierChart(){
             showNotification(`Refresh grafico fornitori non ancora implementato.`, 'info');
        }

    </script>
</body>
</html>
}