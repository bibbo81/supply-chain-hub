<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Analisi Costi</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
    
    <!-- Sortable.js for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <!-- jsPDF & autoTable -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Solarium Design System -->
    <link rel="stylesheet" href="/solarium.css">
    
    <!-- Auth System -->
    <script src="/auth.js"></script>
    
    <!-- Page Protection & User Info Update -->
    <script>
        // Funzione per aggiornare le informazioni dell'utente nell'header
        function updateHeaderUserInfo() {
            const user = window.auth ? window.auth.getCurrentUser() : null;
            if (user) {
                const userNameEl = document.getElementById('userName');
                const userEmailEl = document.getElementById('userEmail');
                const userInitialEl = document.getElementById('userInitial');
                const userFullNameEl = document.getElementById('userFullName');

                let displayName = 'Utente';
                let initial = 'U';

                if (user.user_metadata && user.user_metadata.full_name) {
                    displayName = user.user_metadata.full_name;
                } else if (user.user_metadata && user.user_metadata.name) {
                    displayName = user.user_metadata.name;
                } else if (user.email) {
                    displayName = user.email.split('@')[0];
                    displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
                }
                
                const words = displayName.split(' ').filter(w => w.length > 0);
                if (words.length >= 2) {
                    initial = words[0][0].toUpperCase() + words[1][0].toUpperCase();
                } else if (words.length === 1) {
                    initial = words[0][0].toUpperCase();
                }

                if (userNameEl) userNameEl.textContent = displayName;
                if (userInitialEl) userInitialEl.textContent = initial;
                if (userFullNameEl) userFullNameEl.textContent = displayName;
                if (userEmailEl) userEmailEl.textContent = user.email || '';
            }
        }

        (function() {
            console.log('[Costs] Checking authentication...');
            function checkAuth() {
                if (!window.auth) {
                    setTimeout(checkAuth, 100);
                    return;
                }
                if (!window.auth.isAuthenticated()) {
                    console.log('[Costs] Not authenticated, redirecting...');
                    window.location.replace('/login.html');
                    return;
                }
                console.log('[Costs] User authenticated');
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', updateHeaderUserInfo);
                } else {
                    updateHeaderUserInfo();
                }
            }
            checkAuth();
        })();
    </script>
    
    <style>
        /* Page Specific Styles */
        .sol-main-content { margin-top: 80px; padding: var(--sol-space-xl); max-width: 1600px; margin-left: auto; margin-right: auto; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); gap: var(--sol-space-lg); margin-bottom: var(--sol-space-2xl); }
        .kpi-card { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-xl); transition: all 0.3s ease; position: relative; }
        .kpi-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sol-space-md); position: relative; padding-top: 12px; /* Spazio per la drag bar */ }
        .kpi-title { font-size: 0.875rem; color: var(--sol-text-secondary); font-weight: 500; flex-grow: 1; }
        .kpi-icon-wrapper { display: flex; align-items: center; }
        .kpi-icon { width: 40px; height: 40px; background: var(--sol-gradient-primary); border-radius: var(--sol-radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; }
        .kpi-value { font-size: 2rem; font-weight: 700; color: var(--sol-text-primary); margin-bottom: var(--sol-space-sm); }
        .kpi-change { display: flex; align-items: center; gap: 4px; font-size: 0.875rem; font-weight: 600; }
        .kpi-change.positive { color: #34C759; }
        .kpi-change.negative { color: #FF3B30; }

        .card-drag-handle { 
            position: absolute;
            top: -14px; /* Ancora più in alto, quasi a filo con il bordo superiore della card */
            left: 50%;
            transform: translateX(-50%);
            color: var(--sol-text-tertiary);
            background-color: rgba(255,255,255,0.08); 
            padding: 3px var(--sol-space-lg); /* Padding orizzontale ridotto (era var(--sol-space-xl)) */
            border-radius: var(--sol-radius-sm); /* Raggio più piccolo per una barra più sottile */
            line-height: 1;
            font-size: 0.9rem; /* Icona leggermente più piccola per adattarsi */
            cursor: grab; 
            opacity: 0.7; 
            transition: opacity var(--sol-transition-fast), background-color var(--sol-transition-fast);
            z-index: 10; 
        }
        .kpi-card:hover .card-drag-handle, .chart-card:hover .card-drag-handle { opacity: 1; background-color: rgba(255,255,255,0.15); }
        
        .kpi-card.dragging, .chart-card.dragging { opacity: 0.6; transform: scale(0.97); box-shadow: var(--sol-shadow-lg); border: 1px solid var(--sol-text-accent); }
        .kpi-card.sortable-chosen, .chart-card.sortable-chosen { /* Style for the original element while dragging */  }
        .kpi-card.dragging, .kpi-card.sortable-chosen, .chart-card.dragging, .chart-card.sortable-chosen { user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }

        .filter-bar { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-lg); margin-bottom: var(--sol-space-2xl); display: flex; gap: var(--sol-space-md); flex-wrap: wrap; align-items: center; }
        .filter-group { display: flex; flex-direction: column; gap: var(--sol-space-xs); flex: 1; min-width: 200px; }
        .filter-label { font-size: 0.75rem; color: var(--sol-text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(460px, 1fr)); gap: var(--sol-space-lg); margin-bottom: var(--sol-space-2xl); }
        .chart-card { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-xl); box-shadow: var(--sol-shadow-md); overflow: hidden; display: flex; flex-direction: column;}
        .chart-card.full-width { grid-column: 1 / -1; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--sol-space-lg); position: relative; padding-top: 12px; /* Spazio per la drag bar */ }
        .chart-title { font-size: 1.125rem; font-weight: 600; color: var(--sol-text-primary); flex-grow: 1; }
        .chart-actions-wrapper { display: flex; align-items: center; }
        .chart-actions { display: flex; gap: var(--sol-space-sm); }
        .chart-container { width: 100%; height: 350px; flex-grow: 1; }
        
        .comparison-section { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-xl); margin-bottom: var(--sol-space-2xl); }
        .budget-bar { display: flex; align-items: center; gap: var(--sol-space-md); margin-bottom: var(--sol-space-lg); }
        .budget-progress { flex: 1; height: 24px; background: rgba(255, 255, 255, 0.05); border-radius: var(--sol-radius-full); overflow: hidden; position: relative; }
        .budget-fill { height: 100%; background: var(--sol-gradient-primary); border-radius: var(--sol-radius-full); transition: width 0.6s ease; position: relative; }
        .budget-fill.warning { background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%); }
        .budget-fill.danger { background: linear-gradient(135deg, #FF3B30 0%, #FF1744 100%); }
        .budget-label { position: absolute; right: var(--sol-space-md); top: 50%; transform: translateY(-50%); font-size: 0.875rem; font-weight: 600; color: white; }
        
        .table-section { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); overflow: hidden; }
        .table-header { padding: var(--sol-space-lg) var(--sol-space-xl); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); padding: var(--sol-space-md); text-align: left; font-weight: 600; font-size: 0.875rem; color: var(--sol-text-secondary); position: sticky; top: 0; z-index: 10; }
        .data-table td { padding: var(--sol-space-md); border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: var(--sol-text-primary); }
        .data-table tr:hover td { background: rgba(255, 255, 255, 0.02); }
        
        .cost-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .cost-badge.high { background: rgba(255, 59, 48, 0.15); color: #FF3B30; }
        .cost-badge.medium { background: rgba(255, 149, 0, 0.15); color: #FF9500; }
        .cost-badge.low { background: rgba(52, 199, 89, 0.15); color: #34C759; }
        
        .export-menu { position: absolute; top: 100%; right: 0; margin-top: var(--sol-space-sm); background: rgba(20, 20, 30, 0.95); backdrop-filter: var(--sol-blur-xl); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--sol-radius-lg); padding: var(--sol-space-sm); min-width: 180px; display: none; z-index: 1000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .export-menu.active { display: block; }
        .export-option { display: block; width: 100%; padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); text-decoration: none; border-radius: var(--sol-radius-sm); transition: var(--sol-transition-base); background: none; border: none; text-align: left; cursor: pointer; font-size: 0.875rem; }
        .export-option:hover { background: rgba(255, 255, 255, 0.05); }
        
        .sol-backdrop { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); backdrop-filter: var(--sol-blur-sm); z-index: 998; opacity: 0; visibility: hidden; transition: var(--sol-transition-base); }
        .sol-backdrop.active { opacity: 1; visibility: visible; }

        .sol-dropdown { position: absolute; top: 70px; right: var(--sol-space-xl); background: rgba(20, 20, 30, 0.95) !important; backdrop-filter: var(--sol-blur-xl); -webkit-backdrop-filter: var(--sol-blur-xl); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: var(--sol-radius-lg); padding: var(--sol-space-sm); min-width: 200px; display: none; z-index: 1000; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .sol-dropdown-item { display: block; width: 100%; padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); text-decoration: none; border-radius: var(--sol-radius-sm); transition: var(--sol-transition-base); background: none; border: none; text-align: left; cursor: pointer; }
        .sol-dropdown-item:hover { background: rgba(255, 255, 255, 0.05); }
        .notification-item { padding: var(--sol-space-md) var(--sol-space-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: var(--sol-transition-base); }
        .notification-item:hover { background: rgba(255,255,255,0.03); }
        .noti-icon-wrap { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .noti-icon-wrap.error { background: rgba(255,59,48,0.15); color: #FF3B30; }
        .noti-icon-wrap.info { background: rgba(0,122,255,0.15); color: #007AFF; }
        .noti-content-wrap .noti-title { margin: 0; font-weight: 500; font-size: 0.875rem; }
        .noti-content-wrap .noti-desc { margin: 0; margin-top: 2px; font-size: 0.75rem; color: var(--sol-text-secondary); }
        .noti-content-wrap .noti-time { margin: 0; margin-top: 4px; font-size: 0.75rem; color: var(--sol-text-tertiary); }
        .sol-link { color: var(--sol-text-primary); text-decoration: none; font-size: 0.875rem; font-weight: 500; }
        .sidebar-section-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--sol-text-tertiary); margin-bottom: var(--sol-space-sm); padding: 0 var(--sol-space-lg); }

        @media (max-width: 768px) {
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-group { min-width: 100%; }
            .charts-grid { grid-template-columns: 1fr; }
            .kpi-grid { grid-template-columns: 1fr; }
            .chart-container { height: 300px; }
            .table-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .data-table { min-width: 600px; }
            .sol-header-center { display: none; }
            .sol-logo-text { display: none; }
            #userName { display: none; }
            #userMenuBtn .fa-chevron-down { display: none; }
            #notificationDropdown { right: 10px !important; left: 10px; width: auto; max-width: calc(100vw - 20px); }
            .sol-header-content { padding: 0 var(--sol-space-md); }
            .sol-header-right { gap: var(--sol-space-xs) !important; }
        }
        
        .loading-skeleton { background: linear-gradient(90deg, rgba(255, 255, 255, 0.05) 25%, rgba(255, 255, 255, 0.1) 50%, rgba(255, 255, 255, 0.05) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: var(--sol-radius-md); }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .sol-animate-in { animation: sol-fade-in 0.6s ease-out; }
        @keyframes sol-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <header class="sol-header" style="overflow: visible;">
        <div class="sol-header-content">
            <div class="sol-header-left" style="display: flex; align-items: center; gap: var(--sol-space-lg);">
                <button class="sol-btn sol-btn-glass" id="menuToggle" style="padding: var(--sol-space-sm);">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="/dashboard.html" class="sol-logo">
                    <div class="sol-logo-icon">SCH</div>
                    <span class="sol-logo-text">Supply Chain Hub</span>
                </a>
            </div>
            <div class="sol-header-center" style="flex: 1; max-width: 500px; margin: 0 var(--sol-space-xl);">
                <div style="position: relative;">
                    <input type="search" class="sol-search" placeholder="Cerca costi, spedizioni..." style="padding-left: 2.5rem;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--sol-text-tertiary);"></i>
                </div>
            </div>
            <div class="sol-header-right" style="display: flex; align-items: center; gap: var(--sol-space-md);">
                <button class="sol-btn sol-btn-glass" id="notificationBtn" style="position: relative; padding: var(--sol-space-sm); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-bell" style="font-size: 1.25rem;"></i>
                    <span style="position: absolute; top: 9px; right: 6px; background: linear-gradient(135deg, #FF3B30 0%, #FF6B6B 100%); width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: white; box-shadow: 0 2px 8px rgba(255, 59, 48, 0.3);">3</span>
                </button>
                <button class="sol-btn sol-btn-glass" id="userMenuBtn" style="display: flex; align-items: center; gap: var(--sol-space-sm);">
                    <div style="width: 32px; height: 32px; background: var(--sol-gradient-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                        <span id="userInitial">U</span>
                    </div>
                    <span id="userName">Utente</span>
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="sol-dropdown" id="userDropdown">
                    <div style="padding: var(--sol-space-md); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <p style="font-weight: 600; color: var(--sol-text-primary); margin: 0;" id="userFullName">Nome Utente</p>
                        <p style="font-size: 0.75rem; color: var(--sol-text-secondary); margin: 0; margin-top: 2px;" id="userEmail">email@example.com</p>
                    </div>
                    <a href="/profile.html" class="sol-dropdown-item"><i class="fas fa-user"></i> Profilo</a>
                    <a href="/settings.html" class="sol-dropdown-item"><i class="fas fa-cog"></i> Impostazioni</a>
                    <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: var(--sol-space-sm) 0;"></div>
                    <button class="sol-dropdown-item" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Esci</button>
                </div>
            </div>
        </div>
    </header>

    <div class="sol-dropdown" id="notificationDropdown">
        <div style="padding: var(--sol-space-lg); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <h3 style="margin: 0; font-size: 1rem; font-weight: 600;">Notifiche</h3>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
            <div class="notification-item"><div style="display: flex; gap: var(--sol-space-md);"><div class="noti-icon-wrap error"><i class="fas fa-exclamation-triangle"></i></div><div class="noti-content-wrap"><p class="noti-title">Alert Costo Elevato</p><p class="noti-desc">Spedizione ODA-123 supera budget.</p><p class="noti-time">1 ora fa</p></div></div></div>
            <div class="notification-item"><div style="display: flex; gap: var(--sol-space-md);"><div class="noti-icon-wrap info"><i class="fas fa-info-circle"></i></div><div class="noti-content-wrap"><p class="noti-title">Nuovo Report Disponibile</p><p class="noti-desc">Report costi Q2 pronto.</p><p class="noti-time">Ieri</p></div></div></div>
        </div>
        <div style="padding: var(--sol-space-md) var(--sol-space-lg); border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center;">
            <a href="/notifications.html" class="sol-link">Vedi tutte le notifiche</a>
        </div>
    </div>

    <aside class="sol-sidebar" id="sidebar">
        <nav style="padding: var(--sol-space-lg) 0;">
            <div style="margin-bottom: var(--sol-space-xl);">
                <div class="sidebar-section-title">PRINCIPALE</div>
                <a href="/dashboard.html" class="sol-nav-item"><i class="fas fa-chart-line"></i><span>Dashboard</span></a>
                <a href="/shipments.html" class="sol-nav-item"><i class="fas fa-box"></i><span>Spedizioni</span></a>
                <a href="/carriers.html" class="sol-nav-item"><i class="fas fa-truck"></i><span>Corrieri</span></a>
                <a href="/tracking.html" class="sol-nav-item"><i class="fas fa-map-marker-alt"></i><span>Tracking</span></a>
            </div>
            <div style="margin-bottom: var(--sol-space-xl);">
                <div class="sidebar-section-title">STRUMENTI</div>
                <a href="/import.html" class="sol-nav-item"><i class="fas fa-upload"></i><span>Importa Dati</span></a>
                <a href="/reports.html" class="sol-nav-item"><i class="fas fa-file-alt"></i><span>Report</span></a>
                <a href="/costs.html" class="sol-nav-item active"><i class="fas fa-coins"></i><span>Analisi Costi</span></a>
            </div>
            <div>
                <div class="sidebar-section-title">CONFIGURAZIONE</div>
                <a href="/team.html" class="sol-nav-item"><i class="fas fa-users"></i><span>Team</span></a>
                <a href="/settings.html" class="sol-nav-item"><i class="fas fa-cog"></i><span>Impostazioni</span></a>
                <a href="/billing.html" class="sol-nav-item"><i class="fas fa-credit-card"></i><span>Fatturazione</span></a>
            </div>
        </nav>
    </aside>

    <main class="sol-main-content">
        <div style="margin-bottom: var(--sol-space-2xl);">
            <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: var(--sol-space-sm);">Analisi Costi</h1>
            <p style="color: var(--sol-text-secondary);">Monitora e analizza i costi di trasporto della tua supply chain</p>
        </div>

        <div class="kpi-grid" id="kpiGridContainer">
            <div class="kpi-card sol-animate-in" style="animation-delay: 0.1s;" data-id="totalCostCard">
                <div class="kpi-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="kpi-title">Costo Totale</h3>
                    <div class="kpi-icon-wrapper">
                        <div class="kpi-icon"><i class="fas fa-euro-sign"></i></div>
                    </div>
                </div>
                <div class="kpi-value" id="totalCost">€0</div>
                <div class="kpi-change positive"><i class="fas fa-arrow-down"></i><span id="totalCostChange">0%</span> vs mese precedente</div>
            </div>
            <div class="kpi-card sol-animate-in" style="animation-delay: 0.2s;" data-id="avgShipmentCostCard">
                <div class="kpi-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="kpi-title">Costo Medio Spedizione</h3>
                     <div class="kpi-icon-wrapper">
                        <div class="kpi-icon"><i class="fas fa-box"></i></div>
                    </div>
                </div>
                <div class="kpi-value" id="avgShipmentCost">€0</div>
                <div class="kpi-change negative"><i class="fas fa-arrow-up"></i><span id="avgCostChange">0%</span> vs mese precedente</div>
            </div>
            <div class="kpi-card sol-animate-in" style="animation-delay: 0.3s;" data-id="budgetUsedCard">
                <div class="kpi-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="kpi-title">Budget Utilizzato</h3>
                    <div class="kpi-icon-wrapper">
                        <div class="kpi-icon"><i class="fas fa-chart-pie"></i></div>
                    </div>
                </div>
                <div class="kpi-value" id="budgetUsed">0%</div>
                <div class="kpi-change positive"><i class="fas fa-check-circle"></i><span id="budgetRemaining">€0</span> rimanenti</div>
            </div>
            <div class="kpi-card sol-animate-in" style="animation-delay: 0.4s;" data-id="potentialSavingsCard">
                <div class="kpi-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="kpi-title">Risparmio Potenziale</h3>
                    <div class="kpi-icon-wrapper">
                        <div class="kpi-icon"><i class="fas fa-piggy-bank"></i></div>
                    </div>
                </div>
                <div class="kpi-value" id="potentialSavings">€0</div>
                <div class="kpi-change"><i class="fas fa-info-circle" style="color: #007AFF;"></i><span style="color: var(--sol-text-secondary);">Ottimizzando i corrieri</span></div>
            </div>
        </div>

        <div class="filter-bar">
            <div class="filter-group"><label class="filter-label">Periodo</label><select class="sol-select" id="periodFilter"><option value="7">Ultimi 7 giorni</option><option value="30" selected>Ultimi 30 giorni</option><option value="90">Ultimi 90 giorni</option><option value="365">Ultimo anno</option><option value="custom">Personalizzato</option></select></div>
            <div class="filter-group"><label class="filter-label">Tipo Spedizione</label><select class="sol-select" id="typeFilter"><option value="">Tutti i tipi</option><option value="MARE">Mare</option><option value="AEREO">Aereo</option><option value="STRADA">Strada</option></select></div>
            <div class="filter-group"><label class="filter-label">Spedizioniere</label><select class="sol-select" id="carrierFilter"><option value="">Tutti</option></select></div>
            <div class="filter-group"><label class="filter-label">Fornitore</label><select class="sol-select" id="supplierFilter"><option value="">Tutti</option></select></div>
            <div class="filter-group" style="flex: 0; align-self: flex-end;"><button class="sol-btn sol-btn-primary" onclick="applyFilters()"><i class="fas fa-filter"></i> Applica Filtri</button></div>
        </div>

        <div class="comparison-section">
            <h2 style="font-size: 1.5rem; margin-bottom: var(--sol-space-lg);">Budget vs Costi Effettivi</h2>
            <div class="budget-bar"><span style="font-size: 0.875rem; color: var(--sol-text-secondary); min-width: 80px;">Budget:</span><div class="budget-progress"><div class="budget-fill" id="budgetBar" style="width: 0%;"><span class="budget-label" id="budgetLabel">0%</span></div></div><span style="font-size: 0.875rem; color: var(--sol-text-primary); min-width: 100px; text-align: right;" id="budgetAmount">€0</span></div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--sol-space-lg); margin-top: var(--sol-space-xl);">
                <div><p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Budget Mensile</p><p style="font-size: 1.5rem; font-weight: 700;" id="monthlyBudget">€0</p></div>
                <div><p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Speso Finora</p><p style="font-size: 1.5rem; font-weight: 700;" id="spentAmount">€0</p></div>
                <div><p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Proiezione Fine Mese</p><p style="font-size: 1.5rem; font-weight: 700;" id="projectedAmount">€0</p></div>
                <div><p style="font-size: 0.875rem; color: var(--sol-text-secondary); margin-bottom: var(--sol-space-xs);">Stato Budget</p><p style="font-size: 1.5rem; font-weight: 700;" id="budgetStatus"><span class="cost-badge low">Sotto controllo</span></p></div>
            </div>
        </div>

        <div class="charts-grid" id="chartsGridContainer">
            <div class="chart-card full-width" data-id="costTrendChartCard">
                <div class="chart-header">
                     <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="chart-title">Trend Costi nel Tempo</h3>
                    <div class="chart-actions-wrapper">
                        <div class="chart-actions"><button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('daily')">Giornaliero</button><button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('weekly')">Settimanale</button><button class="sol-btn sol-btn-glass" onclick="updateCostTrendChart('monthly')">Mensile</button></div>
                    </div>
                </div>
                <div class="chart-container" id="costTrendChart"></div>
            </div>
            <div class="chart-card" data-id="carrierCostChartCard">
                <div class="chart-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="chart-title">Costi per Spedizioniere</h3>
                     <div class="chart-actions-wrapper">
                        <button class="sol-btn sol-btn-glass" onclick="toggleChartType('carrier')"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="chart-container" id="carrierCostChart"></div>
            </div>
            <div class="chart-card" data-id="typeCostChartCard">
                <div class="chart-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="chart-title">Costi per Tipo Spedizione</h3>
                     <div class="chart-actions-wrapper">
                        <button class="sol-btn sol-btn-glass" onclick="toggleChartType('type')"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="chart-container" id="typeCostChart"></div>
            </div>
            <div class="chart-card" data-id="supplierCostChartCard">
                <div class="chart-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="chart-title">Top 10 Fornitori per Costo</h3>
                    <div class="chart-actions-wrapper">
                        <button class="sol-btn sol-btn-glass" onclick="refreshSupplierChart()"><i class="fas fa-sync-alt"></i></button>
                    </div>
                </div>
                <div class="chart-container" id="supplierCostChart"></div>
            </div>
            <div class="chart-card" data-id="costDistributionChartCard">
                <div class="chart-header">
                    <i class="fas fa-grip-lines card-drag-handle"></i>
                    <h3 class="chart-title">Distribuzione Costi</h3>
                    <div class="chart-actions-wrapper">
                        <div style="position: relative;"><button class="sol-btn sol-btn-primary" onclick="toggleExportMenu(event)"><i class="fas fa-download"></i> Export</button><div class="export-menu" id="exportMenu"><button class="export-option" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button><button class="export-option" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button><button class="export-option" onclick="exportToCSV()"><i class="fas fa-file-csv"></i> Export CSV</button></div></div>
                    </div>
                </div>
                <div class="chart-container" id="costDistributionChart"></div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-header">
                <h3 style="font-size: 1.25rem; font-weight: 600;">Dettaglio Costi Spedizioni</h3>
                <div style="display: flex; gap: var(--sol-space-md);"><input type="search" class="sol-input" placeholder="Cerca..." id="tableSearch" style="width: 250px;"><button class="sol-btn sol-btn-glass" onclick="refreshTable()"><i class="fas fa-sync-alt"></i></button></div>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="costsTable">
                    <thead><tr><th onclick="sortTable('n_oda')" style="cursor: pointer;">N. ODA <i class="fas fa-sort"></i></th><th onclick="sortTable('data_partenza')" style="cursor: pointer;">Data <i class="fas fa-sort"></i></th><th onclick="sortTable('fornitore')" style="cursor: pointer;">Fornitore <i class="fas fa-sort"></i></th><th onclick="sortTable('spedizioniere')" style="cursor: pointer;">Spedizioniere <i class="fas fa-sort"></i></th><th onclick="sortTable('tipo_spedizione')" style="cursor: pointer;">Tipo <i class="fas fa-sort"></i></th><th onclick="sortTable('quantita')" style="cursor: pointer;">Quantità <i class="fas fa-sort"></i></th><th onclick="sortTable('costo_trasporto')" style="cursor: pointer;">Costo Trasporto <i class="fas fa-sort"></i></th><th onclick="sortTable('costo_unitario_trasporto')" style="cursor: pointer;">Costo/Unità <i class="fas fa-sort"></i></th><th>Livello Costo</th></tr></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div style="padding: var(--sol-space-lg); display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="color: var(--sol-text-secondary); font-size: 0.875rem;">Mostrando <span id="showingFrom">0</span>-<span id="showingTo">0</span> di <span id="totalRecords">0</span> righe</div>
                <div style="display: flex; gap: var(--sol-space-sm);"><button class="sol-btn sol-btn-glass" onclick="previousPage()" id="prevBtn" disabled><i class="fas fa-chevron-left"></i></button><span style="padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary);">Pagina <span id="currentPage">1</span> di <span id="totalPages">1</span></span><button class="sol-btn sol-btn-glass" onclick="nextPage()" id="nextBtn"><i class="fas fa-chevron-right"></i></button></div>
            </div>
        </div>
    </main>

    <div class="sol-backdrop" id="backdrop"></div>

    <script>
        let costsData = [];
        let filteredData = [];
        let chartInstances = {};
        let currentPage = 1;
        const recordsPerPage = 20;
        let sortColumn = 'data_partenza';
        let sortDirection = 'desc';
        
        const chartTheme = { theme: { mode: 'dark' }, chart: { background: 'transparent', toolbar: { show: false }, fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif', animations: { enabled: true, easing: 'easeinout', speed: 800 }}, grid: { borderColor: 'rgba(255, 255, 255, 0.1)', strokeDashArray: 0 }, colors: ['#007AFF', '#5856D6', '#34C759', '#FF9500', '#FF3B30', '#AF52DE', '#FF2D55', '#00C7BE'], dataLabels: { enabled: false }, stroke: { curve: 'smooth', width: 3 }, xaxis: { labels: { style: { colors: 'rgba(255, 255, 255, 0.5)' } }, axisBorder: { show: false }, axisTicks: { show: false }}, yaxis: { labels: { style: { colors: 'rgba(255, 255, 255, 0.5)' }, formatter: (val) => formatCurrency(val) }}, legend: { labels: { colors: 'rgba(255, 255, 255, 0.7)' }}, tooltip: { theme: 'dark', style: { fontSize: '12px' }}};

        document.addEventListener('DOMContentLoaded', function() {
            setupGlobalHeaderListeners();
            setupPageSpecificEventListeners();
            loadCostsData();
            setupDraggableCards();
            window.addEventListener('resize', debounce(handleChartResize, 250));
        });

        function formatCurrency(value, decimals = 0) { if (typeof value !== 'number') value = parseFloat(value) || 0; return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value); }
        function formatNumber(value, decimals = 0) { if (typeof value !== 'number') value = parseFloat(value) || 0; return new Intl.NumberFormat('it-IT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value); }
        
        function setupGlobalHeaderListeners() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('backdrop');
            if (menuToggle && sidebar && backdrop) {
                menuToggle.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); sidebar.classList.toggle('active'); backdrop.classList.toggle('active'); document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : ''; });
                backdrop.addEventListener('click', () => { sidebar.classList.remove('active'); backdrop.classList.remove('active'); document.body.style.overflow = ''; });
            }
            const userMenuBtn = document.getElementById('userMenuBtn');
            const userDropdown = document.getElementById('userDropdown');
            const notificationBtn = document.getElementById('notificationBtn');
            const notificationDropdown = document.getElementById('notificationDropdown');
            if (userMenuBtn && userDropdown) {
                userMenuBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); if (notificationDropdown) notificationDropdown.style.display = 'none'; userDropdown.style.display = userDropdown.style.display === 'none' ? 'block' : 'none'; });
                userDropdown.addEventListener('click', (e) => e.stopPropagation());
            }
            if (notificationBtn && notificationDropdown) {
                notificationBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); if (userDropdown) userDropdown.style.display = 'none'; notificationDropdown.style.display = notificationDropdown.style.display === 'none' ? 'block' : 'none'; });
            }
            document.addEventListener('click', (e) => {
                if (userDropdown && userDropdown.style.display !== 'none' && userMenuBtn && !userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) userDropdown.style.display = 'none';
                if (notificationDropdown && notificationDropdown.style.display !== 'none' && notificationBtn && !notificationBtn.contains(e.target) && !notificationDropdown.contains(e.target)) notificationDropdown.style.display = 'none';
            });
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) { logoutBtn.addEventListener('click', (e) => { e.preventDefault(); if (window.auth && window.auth.logout) window.auth.logout(); else { localStorage.removeItem('sb-access-token'); localStorage.removeItem('supabase.auth.token'); localStorage.removeItem('user'); window.location.replace('/login.html'); }}); }
        }

        function setupPageSpecificEventListeners() {
            const tableSearchEl = document.getElementById('tableSearch');
            if (tableSearchEl) tableSearchEl.addEventListener('input', debounce((e) => filterTableData(e.target.value.toLowerCase()), 300));
            const periodFilterEl = document.getElementById('periodFilter');
            if (periodFilterEl) periodFilterEl.addEventListener('change', (e) => { if (e.target.value === 'custom') showDatePickerModal(); else applyFilters(); });
            ['typeFilter', 'carrierFilter', 'supplierFilter'].forEach(id => { const el = document.getElementById(id); if (el) el.addEventListener('change', applyFilters); });
        }
        
        function setupDraggableCards() {
            const kpiGrid = document.getElementById('kpiGridContainer');
            if (kpiGrid && window.Sortable) { new Sortable(kpiGrid, { group: 'kpiCards', animation: 150, ghostClass: 'dragging', draggable: '.kpi-card', handle: '.card-drag-handle', forceFallback: true }); }
            const chartsGrid = document.getElementById('chartsGridContainer');
            if (chartsGrid && window.Sortable) { new Sortable(chartsGrid, { group: 'chartCards', animation: 150, ghostClass: 'dragging', draggable: '.chart-card', handle: '.card-drag-handle', forceFallback: true }); }
        }

        async function loadCostsData() {
            showLoadingSkeletons(true);
            try {
                const token = localStorage.getItem('sb-access-token') || localStorage.getItem('supabase.auth.token');
                const period = document.getElementById('periodFilter')?.value || '30';
                const response = await fetch(`/.netlify/functions/get-costs?period=${period}`, { headers: { 'Authorization': `Bearer ${token}` }});
                if (!response.ok) { console.error('Failed to load costs data, status:', response.status); showNotification(`Errore caricamento dati (${response.status}), uso dati demo.`, 'error'); loadMockData(); return; }
                const data = await response.json();
                if (!data || !data.shipments) { console.error('Invalid data structure from API'); showNotification('Dati API non validi, uso dati demo.', 'error'); loadMockData(); return; }
                costsData = data.shipments || [];
                applyFiltersAndRender(data.kpis, data.budget); 
                populateFilters();
            } catch (error) { console.error('Error loading costs:', error); showNotification(`Errore critico caricamento (${error.message}), uso dati demo.`, 'error'); loadMockData(); } 
            finally { showLoadingSkeletons(false); }
        }

        function applyFiltersAndRender(kpisFromLoad, budgetFromLoad) {
            const type = document.getElementById('typeFilter')?.value;
            const carrier = document.getElementById('carrierFilter')?.value;
            const supplier = document.getElementById('supplierFilter')?.value;
            const searchTerm = document.getElementById('tableSearch')?.value.toLowerCase() || "";

            filteredData = costsData.filter(item => 
                (!type || item.tipo_spedizione === type) &&
                (!carrier || item.spedizioniere === carrier) &&
                (!supplier || item.fornitore === supplier) &&
                (!searchTerm || Object.values(item).some(val => String(val).toLowerCase().includes(searchTerm)))
            );
            
            const kpisToUse = kpisFromLoad || calculateKPIs(costsData); 
            const budgetToUse = budgetFromLoad || calculateBudgetInfo(costsData, 150000);

            updateKPIs(kpisToUse);
            updateBudgetComparison(budgetToUse);
            updateCharts(); 
            updateTable();
        }
        
        function calculateKPIs(data) { const total = data.reduce((s, i) => s + (i.costo_trasporto || 0), 0); return { totalCost: total, avgShipmentCost: data.length > 0 ? total / data.length : 0, shipmentCount: data.length, totalCostChange: -5, avgCostChange: 2.1, potentialSavings: total * 0.08 }; }
        function calculateBudgetInfo(data, monthlyBudget) { const spent = data.reduce((s, i) => s + (i.costo_trasporto||0),0); const perc = Math.min(Math.round((spent/monthlyBudget)*100),100); return { monthly: monthlyBudget, spent, projected: spent*1.1, percentage: perc, remaining: Math.max(0, monthlyBudget-spent)};}

        function showLoadingSkeletons(isLoading) {
            const kpiTargets = ['totalCost', 'totalCostChange', 'avgShipmentCost', 'avgCostChange', 'budgetUsed', 'budgetRemaining', 'potentialSavings'];
            kpiTargets.forEach(id => { const el = document.getElementById(id); if(el) { el.classList.toggle('loading-skeleton', isLoading); if(isLoading) {el.style.minHeight = '1.5em'; el.textContent='';} else {el.style.minHeight='';}}});
            document.querySelectorAll('.chart-container').forEach(el => { if(isLoading) el.innerHTML = '<div class="loading-skeleton" style="width:100%; height:100%;"></div>';});
            const tb = document.getElementById('tableBody'); if(tb && isLoading) tb.innerHTML = `<tr><td colspan="9" style="text-align:center;"><div class="loading-skeleton" style="width:80%; height:150px; margin:auto;"></div></td></tr>`;
        }

        function loadMockData() { const mock = generateMockCostsData(); costsData = mock.shipments; applyFiltersAndRender(mock.kpis, mock.budget); populateFilters(); }
        function generateMockCostsData() { /* ... (La tua funzione mock, assicurati che ritorni kpis e budget come calcolato sopra) ... */ return {"shipments":[{"n_oda":"ODA-MOCK-2073","cod_art":"ART-M238","data_partenza":"2025-05-10T12:00:00.000Z","fornitore":"Gamma Inc","spedizioniere":"UPS","tipo_spedizione":"STRADA","quantita":161,"costo_trasporto":1078.58,"costo_unitario_trasporto":6.7,"stato_spedizione":"In transito"}],"kpis":{"totalCost":1078.58,"avgShipmentCost":1078.58,"shipmentCount":1,"totalCostChange":-5,"avgCostChange":2.1,"potentialSavings":86.29},"budget":{"monthly":150000,"spent":1078.58,"projected":1186.44,"percentage":1,"remaining":148921.42}}; }

        function updateKPIs(kpis) { if(!kpis) return; document.getElementById('totalCost').textContent = formatCurrency(kpis.totalCost); const tcCE=document.getElementById('totalCostChange'),tcCIP=tcCE?.parentElement; if(tcCE&&tcCIP){tcCE.textContent=Math.abs(kpis.totalCostChange||0).toFixed(1)+'%';tcCIP.className=(kpis.totalCostChange||0)<0?'kpi-change positive':'kpi-change negative';tcCIP.querySelector('i').className=`fas fa-arrow-${(kpis.totalCostChange||0)<0?'down':'up'}`;} document.getElementById('avgShipmentCost').textContent=formatCurrency(kpis.avgShipmentCost); const acCE=document.getElementById('avgCostChange'),acCIP=acCE?.parentElement; if(acCE&&acCIP){acCE.textContent=Math.abs(kpis.avgCostChange||0).toFixed(1)+'%';acCIP.className=(kpis.avgCostChange||0)<0?'kpi-change positive':'kpi-change negative';acCIP.querySelector('i').className=`fas fa-arrow-${(kpis.avgCostChange||0)<0?'down':'up'}`;} document.getElementById('budgetUsed').textContent=(kpis.budgetUsed||0)+'%'; document.getElementById('budgetRemaining').textContent=formatCurrency(kpis.budgetRemaining||0); document.getElementById('potentialSavings').textContent=formatCurrency(kpis.potentialSavings||0); }
        function updateBudgetComparison(budget) { if(!budget) return; const p=budget.percentage||0,bB=document.getElementById('budgetBar'),bL=document.getElementById('budgetLabel'); if(bB)bB.style.width=p+'%'; if(bL)bL.textContent=p+'%'; if(bB){if(p>90)bB.className='budget-fill danger';else if(p>75)bB.className='budget-fill warning';else bB.className='budget-fill';} document.getElementById('monthlyBudget').textContent=formatCurrency(budget.monthly); document.getElementById('spentAmount').textContent=formatCurrency(budget.spent); document.getElementById('projectedAmount').textContent=formatCurrency(budget.projected); const sE=document.getElementById('budgetStatus'); if(sE){if(p>90)sE.innerHTML='<span class="cost-badge high">Oltre budget</span>';else if(p>75)sE.innerHTML='<span class="cost-badge medium">Attenzione</span>';else sE.innerHTML='<span class="cost-badge low">Sotto controllo</span>';} document.getElementById('budgetAmount').textContent=formatCurrency(budget.monthly); }

        function updateCharts() { 
            setTimeout(() => {
                updateCostTrendChart(); 
                updateCarrierCostChart(); 
                updateTypeCostChart(); 
                updateSupplierCostChart(); 
                updateCostDistributionChart();
            }, 100);
        }
        
        function updateCostTrendChart(period = 'daily') { const data = prepareTrendData(period); const opts = {...chartTheme, series:[{name:'Costo Trasporto',data}], chart:{...chartTheme.chart,type:'area',height:350}, xaxis:{...chartTheme.xaxis,type:'datetime'}, fill:{type:'gradient',gradient:{shadeIntensity:1,opacityFrom:0.7,opacityTo:0.2,stops:[0,90,100]}}}; renderOrUpdateChart('costTrend',"#costTrendChart",opts); }
        function updateCarrierCostChart() { const data = aggregateByCarrier(); const opts = {...chartTheme,series:data.values,labels:data.labels,chart:{...chartTheme.chart,type:'donut',height:350},plotOptions:{pie:{donut:{size:'65%'}}},responsive:[{breakpoint:480,options:{chart:{width:300},legend:{position:'bottom'}}}]}; renderOrUpdateChart('carrierCost',"#carrierCostChart",opts,true); }
        function updateTypeCostChart() { const data = aggregateByType(); const opts = {...chartTheme,series:[{name:'Costo',data:data.values}],chart:{...chartTheme.chart,type:'bar',height:350},xaxis:{...chartTheme.xaxis,categories:data.labels},plotOptions:{bar:{borderRadius:8,dataLabels:{position:'top'}}}}; renderOrUpdateChart('typeCost',"#typeCostChart",opts,true); }
        function updateSupplierCostChart() { const data = aggregateBySupplier(); const opts = {...chartTheme,series:[{name:'Costo Trasporto',data:data.values.slice(0,10)}],chart:{...chartTheme.chart,type:'bar',height:350},xaxis:{...chartTheme.xaxis,categories:data.labels.slice(0,10)},plotOptions:{bar:{horizontal:true,borderRadius:4}}}; renderOrUpdateChart('supplierCost',"#supplierCostChart",opts,true); }
        function updateCostDistributionChart() { const data = calculateCostDistribution(); const opts = {...chartTheme,series:data.values,labels:data.labels,chart:{...chartTheme.chart,type:'pie',height:350},legend:{position:'right'}}; renderOrUpdateChart('costDistribution',"#costDistributionChart",opts,true); }
        
        function renderOrUpdateChart(key, sel, opts, recreate=false) { 
            const el=document.querySelector(sel); 
            if(!el) { console.warn(`Chart element ${sel} not found for chart: ${key}`); return; }
            
            if (el.offsetParent === null || el.offsetHeight <= 0 || el.offsetWidth <= 0) { 
                console.warn(`Chart container ${sel} for ${key} is not visible or has invalid dimensions (H:${el.offsetHeight}, W:${el.offsetWidth}). Retrying...`);
                setTimeout(() => renderOrUpdateChart(key, sel, opts, recreate), 250);
                return;
            }
            
            const containerHeight = el.offsetHeight > 50 ? el.offsetHeight : 350; 
            
            opts.chart = { 
                ...opts.chart, 
                height: containerHeight, 
                width: '100%'
            };

            try {
                if(chartInstances[key] && typeof chartInstances[key].updateOptions === 'function' && !recreate){
                    chartInstances[key].updateOptions(opts, true, true, true).catch(e => console.error(`Error updating chart ${key}:`, e));
                } else {
                    if(chartInstances[key] && typeof chartInstances[key].destroy === 'function') {
                        chartInstances[key].destroy();
                        delete chartInstances[key];
                    }
                    el.innerHTML = ''; 
                    chartInstances[key] = new ApexCharts(el, opts); 
                    chartInstances[key].render().catch(e => console.error(`Error rendering new chart ${key}:`, e));
                }
            } catch(e) {
                console.error(`General error in renderOrUpdateChart for ${key}:`, e);
                setTimeout(() => {
                    try {
                        if(chartInstances[key]) chartInstances[key].destroy();
                        delete chartInstances[key];
                        el.innerHTML = '';
                        chartInstances[key] = new ApexCharts(el, opts);
                        chartInstances[key].render().catch(e2 => console.error(`Failed to render chart ${key} after retry:`, e2));
                    } catch(e2) {
                        console.error(`Catastrophic failure rendering chart ${key} after retry:`, e2);
                    }
                }, 500);
            }
        }

        function prepareTrendData(period) { const g={}; filteredData.forEach(i=>{const d=new Date(i.data_partenza); let k; if(period==='daily')k=d.toISOString().split('T')[0]; else if(period==='weekly'){const s=new Date(d);s.setDate(s.getDate()-s.getDay()+(s.getDay()===0?-6:1));k=s.toISOString().split('T')[0];} else k=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; if(!g[k])g[k]=0;g[k]+=(i.costo_trasporto||0);}); return Object.entries(g).sort(([a],[b])=>new Date(a)-new Date(b)).map(([d,v])=>({x:new Date(d).getTime(),y:Math.round(v)}));}
        function aggregateByCarrier() { const g={}; filteredData.forEach(i=>{const c=i.spedizioniere||'N/D';if(!g[c])g[c]=0;g[c]+=(i.costo_trasporto||0);}); const s=Object.entries(g).sort(([,a],[,b])=>b-a); return{labels:s.map(([l])=>l),values:s.map(([,c])=>Math.round(c))};}
        function aggregateByType() { const g={}; filteredData.forEach(i=>{const t=i.tipo_spedizione||'N/D';if(!g[t])g[t]=0;g[t]+=(i.costo_trasporto||0);}); return{labels:Object.keys(g),values:Object.values(g).map(v=>Math.round(v))};}
        function aggregateBySupplier() { const g={}; filteredData.forEach(i=>{const s=i.fornitore||'N/D';if(!g[s])g[s]=0;g[s]+=(i.costo_trasporto||0);}); const s=Object.entries(g).sort(([,a],[,b])=>b-a); return{labels:s.map(([l])=>l),values:s.map(([,c])=>Math.round(c))};}
        function calculateCostDistribution() { const r={'< €500':0,'€500-€1k':0,'€1k-€2k':0,'€2k-€5k':0,'> €5k':0}; filteredData.forEach(i=>{const c=i.costo_trasporto||0;if(c<500)r['< €500']++;else if(c<1000)r['€500-€1k']++;else if(c<2000)r['€1k-€2k']++;else if(c<5000)r['€2k-€5k']++;else r['> €5k']++;}); return{labels:Object.keys(r),values:Object.values(r)};}

        function updateTable() {
            const tbody=document.getElementById('tableBody'); if(!tbody)return; tbody.innerHTML='';
            const sorted=[...filteredData].sort((a,b)=>{let av=a[sortColumn],bv=b[sortColumn];if(sortColumn==='data_partenza'){av=new Date(av).getTime();bv=new Date(bv).getTime();}else if(typeof av==='string'){av=av.toLowerCase();bv=bv.toLowerCase();}else if(typeof av==='number'&&typeof bv==='number'){}else{av=String(av).toLowerCase();bv=String(bv).toLowerCase();} if(av<bv)return sortDirection==='asc'?-1:1; if(av>bv)return sortDirection==='asc'?1:-1; return 0;});
            const total=sorted.length,pages=Math.ceil(total/recordsPerPage); currentPage=Math.min(currentPage,pages)||1; const start=(currentPage-1)*recordsPerPage,end=start+recordsPerPage,paginated=sorted.slice(start,end);
            if(paginated.length===0&&total>0)tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:var(--sol-space-xl)">Nessun dato per questa pagina.</td></tr>`;
            else if(total===0)tbody.innerHTML=`<tr><td colspan="9" style="text-align:center;padding:var(--sol-space-xl)">Nessun dato per i filtri.</td></tr>`;
            else paginated.forEach(i=>{const r=tbody.insertRow();r.insertCell().textContent=i.n_oda||'-';r.insertCell().textContent=i.data_partenza?new Date(i.data_partenza).toLocaleDateString('it-IT'):'-';r.insertCell().textContent=i.fornitore||'-';r.insertCell().textContent=i.spedizioniere||'-';r.insertCell().textContent=i.tipo_spedizione||'-';r.insertCell().textContent=formatNumber(i.quantita||0);r.insertCell().textContent=formatCurrency(i.costo_trasporto||0);r.insertCell().textContent=formatCurrency(i.costo_unitario_trasporto||0,2);const c=i.costo_trasporto||0;let bc='low';if(c>2000)bc='high';else if(c>500)bc='medium';r.insertCell().innerHTML=`<span class="cost-badge ${bc}">${bc.toUpperCase()}</span>`;});
            document.getElementById('showingFrom').textContent=total>0?start+1:0; document.getElementById('showingTo').textContent=Math.min(end,total); document.getElementById('totalRecords').textContent=total; document.getElementById('currentPage').textContent=currentPage; document.getElementById('totalPages').textContent=pages>0?pages:1;
            document.getElementById('prevBtn').disabled=currentPage===1; document.getElementById('nextBtn').disabled=currentPage===pages||pages===0;
            document.querySelectorAll('.data-table th i.fa-sort').forEach(i=>i.className='fas fa-sort'); const act=document.querySelector(`.data-table th[onclick="sortTable('${sortColumn}')"] i`); if(act)act.className=`fas fa-sort-${sortDirection==='asc'?'up':'down'}`;
        }
        
        function sortTable(col) { if(sortColumn===col)sortDirection=sortDirection==='asc'?'desc':'asc'; else{sortColumn=col;sortDirection='asc';} currentPage=1; updateTable(); }
        function populateFilters() { const cs=[...new Set(costsData.map(i=>i.spedizioniere).filter(Boolean))].sort(),ss=[...new Set(costsData.map(i=>i.fornitore).filter(Boolean))].sort(),cf=document.getElementById('carrierFilter'),sf=document.getElementById('supplierFilter'); if(!cf || !sf) return; const sCar=cf.value,sSup=sf.value; cf.innerHTML='<option value="">Tutti</option>';cs.forEach(c=>{const o=document.createElement('option');o.value=c;o.textContent=c;cf.appendChild(o);}); sf.innerHTML='<option value="">Tutti</option>';ss.forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sf.appendChild(o);}); if(cs.includes(sCar))cf.value=sCar; if(ss.includes(sSup))sf.value=sSup; }
        function applyFilters() { currentPage=1; applyFiltersAndRender(); }
        function filterTableData(term) { applyFiltersAndRender(); } 
        function debounce(fn,delay){let t;return function(...a){clearTimeout(t);t=setTimeout(()=>fn.apply(this,a),delay);};}
        function nextPage(){const tp=Math.ceil(filteredData.length/recordsPerPage);if(currentPage<tp){currentPage++;updateTable();}}
        function previousPage(){if(currentPage>1){currentPage--;updateTable();}}
        
        function toggleExportMenu(e){e.stopPropagation();document.getElementById('exportMenu').classList.toggle('active');}
        async function exportData(fmt){showNotification(`Esportazione ${fmt.toUpperCase()}...`,'info');try{const tk=localStorage.getItem('sb-access-token')||localStorage.getItem('supabase.auth.token'),p=document.getElementById('periodFilter').value,t=document.getElementById('typeFilter').value,c=document.getElementById('carrierFilter').value,s=document.getElementById('supplierFilter').value,dExp={shipments:filteredData,filters:{period:p,tipo_spedizione:t,spedizioniere:c,fornitore:s}};const r=await fetch('/.netlify/functions/export-costs',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${tk}`},body:JSON.stringify({format:fmt,data:dExp})});if(!r.ok){const eD=await r.json();throw new Error(eD.error||`Export ${fmt.toUpperCase()} fallito`);} const b=await r.blob(),u=window.URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=`analisi-costi-${new Date().toISOString().split('T')[0]}.${fmt}`;document.body.appendChild(a);a.click();a.remove();window.URL.revokeObjectURL(u);showNotification(`Export ${fmt.toUpperCase()} completato!`,'success');}catch(e){console.error(`Error export ${fmt}:`,e);showNotification(`Errore export ${fmt.toUpperCase()}: ${e.message}`,'error');} const expMenu = document.getElementById('exportMenu'); if(expMenu) expMenu.classList.remove('active');}
        window.exportToPDF=()=>exportData('pdf'); window.exportToExcel=()=>exportData('excel'); window.exportToCSV=()=>exportData('csv');
        
        if(!window.showNotification){window.showNotification=function(m,type='info'){const n=document.createElement('div');n.className=`sol-notification sol-notification-${type} sol-animate-in`;n.style.cssText=`position:fixed;top:20px;right:20px;padding:15px;background:var(--sol-glass-heavy);color:var(--sol-text-primary);border-radius:8px;z-index:1001;border:1px solid var(--sol-border);backdrop-filter:blur(10px);box-shadow:var(--sol-shadow-md);`;if(type==='error')n.style.borderColor='var(--sol-gradient-error)';if(type==='success')n.style.borderColor='var(--sol-gradient-success)';n.textContent=m;document.body.appendChild(n);setTimeout(()=>n.remove(),3000);}}
        function refreshTable(){ loadCostsData(); showNotification('Tabella aggiornata.','info'); }
        function showDatePickerModal(){ showNotification('Selezione periodo personalizzato non implementata.','info'); }
        function toggleChartType(chartName){ showNotification(`Toggle tipo grafico per ${chartName} non implementato.`,'info'); } 
        function refreshSupplierChart(){ showNotification(`Refresh grafico fornitori non implementato.`,'info'); } 

        function handleChartResize() {
            Object.values(chartInstances).forEach(chartInstance => {
                if (chartInstance && typeof chartInstance.updateOptions === 'function') {
                    try {
                        const chartElement = chartInstance.w.globals.dom.el;
                        if (chartElement && chartElement.offsetParent !== null) { 
                             const currentConfig = chartInstance.w.config;
                             chartInstance.updateOptions({ 
                                 chart: { 
                                     width: '100%', 
                                     height: currentConfig.chart.height // Riapplica l'altezza originale o quella calcolata
                                 } 
                             }, false, false, false); // redrawAnnotations, animate, updateSyncedCharts
                        }
                    } catch (e) {
                        console.warn("Could not update chart on resize:", chartInstance.w.globals.chartID, e);
                    }
                }
            });
        }
    </script>
</body>
</html>
