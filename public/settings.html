<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Hub - Impostazioni</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23007AFF'%3E%3Cpath d='M20 8h-3V4H3c-1.1 0-2 .9-2 2v11h2c0 1.66 1.34 3 3 3s3-1.34 3-3h6c0 1.66 1.34 3 3 3s3-1.34 3-3h2v-5l-3-4zM6 18.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm13.5-9l1.96 2.5H17V9.5h2.5zm-1.5 9c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/solarium.css">
    <script src="/auth.js"></script>
    <script>
        (function() {
            function checkAuth() {
                if (!window.auth) { setTimeout(checkAuth, 100); return; }
                if (!window.auth.isAuthenticated()) { window.location.replace('/login.html'); }
            }
            checkAuth();
        })();
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .sol-main-content { max-width: 1200px; margin: 80px auto 0; padding: var(--sol-space-xl); }
        .settings-nav { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-lg); margin-bottom: var(--sol-space-xl); }
        .settings-nav-list { display: flex; gap: var(--sol-space-sm); overflow-x: auto; scrollbar-width: none; }
        .settings-nav-list::-webkit-scrollbar { display: none; }
        .settings-nav-item { padding: var(--sol-space-sm) var(--sol-space-lg); background: transparent; border: 1px solid transparent; border-radius: var(--sol-radius-full); color: var(--sol-text-secondary); font-weight: 500; font-size: 0.875rem; white-space: nowrap; transition: var(--sol-transition-base); cursor: pointer; display: flex; align-items: center; gap: var(--sol-space-xs); }
        .settings-nav-item:hover { background: var(--sol-glass-medium); color: var(--sol-text-primary); }
        .settings-nav-item.active { background: var(--sol-gradient-primary); color: white; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
        .settings-section { display: none; animation: sol-fade-in 0.3s ease-out; }
        .settings-section.active { display: block; }
        .settings-card { background: var(--sol-glass-light); backdrop-filter: var(--sol-blur-lg); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-xl); padding: var(--sol-space-xl); margin-bottom: var(--sol-space-xl); box-shadow: var(--sol-shadow-md); }
        .settings-card-header { margin-bottom: var(--sol-space-xl); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: var(--sol-space-lg); }
        .settings-card-title { font-size: 1.25rem; font-weight: 600; display: flex; align-items: center; gap: var(--sol-space-sm); }
        .settings-card-subtitle { font-size: 0.875rem; color: var(--sol-text-tertiary); margin-top: var(--sol-space-xs); }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--sol-space-lg); }
        .form-group { display: flex; flex-direction: column; gap: var(--sol-space-sm); }
        .form-label { font-size: 0.875rem; font-weight: 500; color: var(--sol-text-secondary); }
        .form-input, .form-select { background: var(--sol-glass-medium); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: var(--sol-radius-md); padding: var(--sol-space-sm) var(--sol-space-md); color: var(--sol-text-primary); font-size: 0.95rem; width: 100%; }
        .form-input:focus, .form-select:focus { outline: none; border-color: rgba(0, 122, 255, 0.5); background: var(--sol-glass-heavy); box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1); }
        .form-helper { font-size: 0.75rem; color: var(--sol-text-quaternary); }
        .settings-actions { display: flex; gap: var(--sol-space-md); margin-top: var(--sol-space-xl); padding-top: var(--sol-space-xl); border-top: 1px solid rgba(255, 255, 255, 0.1); justify-content: flex-end; }
        @media (max-width: 768px) { .sol-main-content { padding: var(--sol-space-md); margin-top: 60px; } .form-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header class="sol-header"></header>
    <aside class="sol-sidebar" id="sidebar"></aside>

    <main class="sol-main-content">
        <div style="margin-bottom: var(--sol-space-2xl);">
            <h1 style="font-size: 2rem; font-weight: 700;">Impostazioni</h1>
            <p style="font-size: 1rem; color: var(--sol-text-tertiary);">Gestisci le configurazioni del tuo account e dell'applicazione</p>
        </div>

        <nav class="settings-nav">
            <div class="settings-nav-list">
                <button class="settings-nav-item active" data-section="general"><i class="fas fa-building"></i> Generale</button>
                <button class="settings-nav-item" data-section="integrations"><i class="fas fa-plug"></i> Integrazioni</button>
                <button class="settings-nav-item" data-section="security"><i class="fas fa-shield-alt"></i> Sicurezza</button>
            </div>
        </nav>

        <section class="settings-section active" id="general-section">
            </section>
        
        <section class="settings-section" id="integrations-section">
            <div class="settings-card">
                <div class="settings-card-header">
                    <h2 class="settings-card-title"><i class="fas fa-ship"></i> Configurazione API ShipsGo</h2>
                    <p class="settings-card-subtitle">Configura le API per il tracking di container marittimi e spedizioni aeree</p>
                </div>
                <div class="form-group" style="margin-bottom: var(--sol-space-xl);">
                    <label class="form-label" for="shipsgoV1ApiKey"><i class="fas fa-anchor"></i> ShipsGo v1.2 API Key (Container)</label>
                    <div style="display: flex; gap: var(--sol-space-sm);">
                        <input type="password" id="shipsgoV1ApiKey" class="form-input" placeholder="Inserisci API Key v1.2" autocomplete="new-password">
                        <button class="sol-btn sol-btn-glass" onclick="toggleApiKeyVisibility('shipsgoV1ApiKey')"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div class="form-group" style="margin-bottom: var(--sol-space-xl);">
                    <label class="form-label" for="shipsgoV2Token"><i class="fas fa-plane"></i> ShipsGo v2.0 Bearer Token (Aereo)</label>
                    <div style="display: flex; gap: var(--sol-space-sm);">
                        <input type="password" id="shipsgoV2Token" class="form-input" placeholder="Inserisci Bearer Token v2.0" autocomplete="new-password">
                        <button class="sol-btn sol-btn-glass" onclick="toggleApiKeyVisibility('shipsgoV2Token')"><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div class="settings-actions" style="justify-content: flex-start;">
                    <button class="sol-btn sol-btn-primary" onclick="saveShipsGoSettings()"><i class="fas fa-save"></i> Salva</button>
                    <button class="sol-btn sol-btn-glass" onclick="testShipsGoConnection()"><i class="fas fa-plug"></i> Test</button>
                </div>
                <div id="shipsgoTestResult" style="margin-top: var(--sol-space-md); display: none;"></div>
            </div>
        </section>

        <section class="settings-section" id="security-section">
             </section>
    </main>
    <div class="sol-backdrop" id="backdrop"></div>

    <script>
        // Funzione per mostrare notifiche
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `sol-notification`; // Semplificato per brevità
            notification.style.cssText = "position: fixed; top: 80px; right: 20px; padding: 1rem; background: #333; color: white; border-radius: 8px; z-index: 1000; transition: opacity 0.3s; opacity: 0;";
            notification.textContent = message;
            if(type === 'error') notification.style.backgroundColor = '#d32f2f';
            if(type === 'success') notification.style.backgroundColor = '#388e3c';
            document.body.appendChild(notification);
            setTimeout(() => { notification.style.opacity = '1'; }, 10);
            setTimeout(() => { notification.style.opacity = '0'; setTimeout(() => notification.remove(), 300); }, 4000);
        }

        // Funzione per mostrare/nascondere la API key
        function toggleApiKeyVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = event.currentTarget;
            if (input.type === 'password') {
                input.type = 'text';
                button.querySelector('i').className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                button.querySelector('i').className = 'fas fa-eye';
            }
        }

        // Funzione per salvare le API Keys
        async function saveShipsGoSettings() {
            const v1Key = document.getElementById('shipsgoV1ApiKey').value.trim();
            const v2Token = document.getElementById('shipsgoV2Token').value.trim();
            try {
                const user = window.auth.getCurrentUser();
                if (!user) throw new Error('Utente non autenticato.');
                const token = localStorage.getItem('sb-access-token') || sessionStorage.getItem('sb-access-token');
                if (!token) throw new Error('Sessione non valida.');
                const apiSettings = {
                    shipsgo_v1_key: v1Key ? btoa(v1Key) : '',
                    shipsgo_v2_token: v2Token ? btoa(v2Token) : ''
                };
                const response = await fetch('/.netlify/functions/update-profile', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'update_api_settings', data: { api_settings: apiSettings } })
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Salvataggio fallito.');
                showNotification('Configurazione API salvata!', 'success');
            } catch (error) {
                showNotification(`Errore: ${error.message}`, 'error');
            }
        }
        
        // Funzione per testare la connessione API
        async function testShipsGoConnection() {
             const resultDiv = document.getElementById('shipsgoTestResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Test in corso...';
             try {
                const token = localStorage.getItem('sb-access-token') || sessionStorage.getItem('sb-access-token');
                if (!token) throw new Error('Sessione non valida.');
                const response = await fetch('/.netlify/functions/test-shipsgo-connection', { headers: { 'Authorization': `Bearer ${token}` } });
                if (!response.ok) throw new Error('Test di connessione fallito.');
                const data = await response.json();
                resultDiv.innerHTML = `<div><strong>Risultati:</strong><br>v1.2: ${data.results.v1.status}<br>v2.0: ${data.results.v2.status}</div>`;
            } catch (error) {
                resultDiv.innerHTML = `<div style="color:red;"><strong>Errore:</strong> ${error.message}</div>`;
            }
        }

        // Funzione per caricare le API keys al caricamento della pagina
        async function loadShipsGoSettings() {
            try {
                const user = window.auth.getCurrentUser();
                if (!user) return;
                const token = localStorage.getItem('sb-access-token') || sessionStorage.getItem('sb-access-token');
                if (!token) return;
                const response = await fetch(`/.netlify/functions/get-profile?id=${user.id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (response.ok) {
                    const profileData = await response.json();
                    if (profileData && profileData.api_settings) {
                        if (profileData.api_settings.shipsgo_v1_key) {
                            try { document.getElementById('shipsgoV1ApiKey').value = atob(profileData.api_settings.shipsgo_v1_key); }
                            catch(e) { console.error("Errore decodifica v1 key", e); }
                        }
                        if (profileData.api_settings.shipsgo_v2_token) {
                            try { document.getElementById('shipsgoV2Token').value = atob(profileData.api_settings.shipsgo_v2_token); }
                            catch(e) { console.error("Errore decodifica v2 token", e); }
                        }
                    }
                }
            } catch (error) {
                console.error("Errore caricamento API settings:", error);
            }
        }

        // Gestione degli eventi principali
        document.addEventListener('DOMContentLoaded', () => {
            // Navigazione a Tab
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const targetId = `${this.dataset.section}-section`;
                    document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
                    document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    const targetSection = document.getElementById(targetId);
                    if (targetSection) targetSection.classList.add('active');
                });
            });

            // Caricamento dati dopo che l'autenticazione è pronta
            function onAuthReady() {
                if(window.auth && window.auth.isAuthenticated()) {
                    loadShipsGoSettings();
                } else if(window.auth) {
                    window.auth.onAuthStateChange((event, session) => {
                        if(event === 'SIGNED_IN' || event === 'INITIAL_USER') loadShipsGoSettings();
                    });
                } else {
                    setTimeout(onAuthReady, 100);
                }
            }
            onAuthReady();
        });
    </script>
</body>
</html>